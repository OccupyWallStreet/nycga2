<!DOCTYPE html>
<!--[if IE 8]>
<html xmlns="http://www.w3.org/1999/xhtml" class="ie8 wp-toolbar"  dir="ltr" lang="en-US">
<![endif]-->
<!--[if !(IE 8) ]><!-->
<html xmlns="http://www.w3.org/1999/xhtml" class="wp-toolbar"  dir="ltr" lang="en-US">
<!--<![endif]-->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Edit Plugins &lsaquo; Network Admin &#8212; WordPress</title>
<script type="text/javascript">
addLoadEvent = function(func){if(typeof jQuery!="undefined")jQuery(document).ready(func);else if(typeof wpOnload!='function'){wpOnload=func;}else{var oldonload=wpOnload;wpOnload=function(){oldonload();func();}}};
var userSettings = {
		'url': '/',
		'uid': '15',
		'time':'1343360098'
	},
	ajaxurl = '/wp-admin/admin-ajax.php',
	pagenow = 'plugin-editor-network',
	typenow = '',
	adminpage = 'plugin-editor-php',
	thousandsSeparator = ',',
	decimalPoint = '.',
	isRtl = 0;
</script>
<link rel='stylesheet' href='http://campaigns.occupy.net/wp-admin/load-styles.php?c=0&amp;dir=ltr&amp;load=admin-bar,wp-admin&amp;ver=3.4.1' type='text/css' media='all' />
<link rel='stylesheet' id='autocomplete-css'  href='http://campaigns.occupy.net/wp-content/plugins/all-in-one-event-calendar/css/jquery.autocomplete.css?ver=1.5' type='text/css' media='all' />
<link rel='stylesheet' id='colorpicker-css'  href='http://campaigns.occupy.net/wp-content/plugins/all-in-one-event-calendar/css/colorpicker.css?ver=1.5' type='text/css' media='all' />
<link rel='stylesheet' id='ai1ec_add_new_event-css'  href='http://campaigns.occupy.net/wp-content/plugins/all-in-one-event-calendar/css/add_new_event.css?ver=1.5' type='text/css' media='all' />
<link rel='stylesheet' id='ai1ec_datepicker-css'  href='http://campaigns.occupy.net/wp-content/plugins/all-in-one-event-calendar/css/datepicker.css?ver=1.5' type='text/css' media='all' />
<link rel='stylesheet' id='thickbox-css'  href='http://campaigns.occupy.net/wp-includes/js/thickbox/thickbox.css?ver=3.4.1' type='text/css' media='all' />
<link rel='stylesheet' id='colors-css'  href='http://campaigns.occupy.net/wp-admin/css/colors-fresh.css?ver=3.4.1' type='text/css' media='all' />
<!--[if lte IE 7]>
<link rel='stylesheet' id='ie-css'  href='http://campaigns.occupy.net/wp-admin/css/ie.css?ver=3.4.1' type='text/css' media='all' />
<![endif]-->
<link rel='stylesheet' id='wpmudev-notification-css-css'  href='http://campaigns.occupy.net/wp-content/plugins/wpmudev-updates/includes/css/notifications.css?ver=3.1.2' type='text/css' media='all' />
<script type='text/javascript'>
/* <![CDATA[ */
var ai1ec_add_new_event = {"now":"1343345698","date_format":"def","month_names":"January,February,March,April,May,June,July,August,September,October,November,December","day_names":"S,M,T,W,T,F,S","week_start_day":"0","twentyfour_hour":"","region":"","duplicate_feed_message":"This feed is already being imported.","invalid_url_message":"Please enter a valid iCalendar URL."};
/* ]]> */
</script>
<script type='text/javascript' src='http://campaigns.occupy.net/wp-admin/load-scripts.php?c=0&amp;load=jquery,swfobject,utils&amp;ver=3.4.1'></script>
<script type='text/javascript' src='http://campaigns.occupy.net/wp-content/plugins/all-in-one-event-calendar/js/jquery.calendrical.js?ver=1.5'></script>
<script type='text/javascript' src='http://campaigns.occupy.net/wp-content/plugins/all-in-one-event-calendar/js/jquery.timespan.js?ver=1.5'></script>
<script type='text/javascript' src='http://campaigns.occupy.net/wp-content/plugins/all-in-one-event-calendar/js/jquery.inputdate.js?ver=1.5'></script>
<script type='text/javascript' src='http://maps.google.com/maps/api/js?sensor=false&#038;language=en&#038;ver=3.4.1'></script>
<script type='text/javascript' src='http://campaigns.occupy.net/wp-content/plugins/all-in-one-event-calendar/js/jquery.autocomplete_geomod.js?ver=1.5'></script>
<script type='text/javascript' src='http://campaigns.occupy.net/wp-content/plugins/all-in-one-event-calendar/js/geo_autocomplete.js?ver=1.5'></script>
<script type='text/javascript' src='http://campaigns.occupy.net/wp-content/plugins/all-in-one-event-calendar/js/element-selector.js?ver=1.5'></script>
<script type='text/javascript' src='http://campaigns.occupy.net/wp-content/plugins/all-in-one-event-calendar/js/jquery-tools-1.2.5.min.js?ver=1.5'></script>
<script type='text/javascript' src='http://campaigns.occupy.net/wp-content/plugins/all-in-one-event-calendar/js/jquery.blockUI.js?ver=1.5'></script>
<script type='text/javascript' src='http://campaigns.occupy.net/wp-content/plugins/all-in-one-event-calendar/js/datepicker.js?ver=1.5'></script>
<script type='text/javascript' src='http://campaigns.occupy.net/wp-content/plugins/all-in-one-event-calendar/js/add_new_event.js?ver=1.5'></script>
<script type='text/javascript' src='http://campaigns.occupy.net/wp-content/plugins/all-in-one-event-calendar/js/colorpicker.js?ver=1.5'></script>
	<link href="http://campaigns.occupy.net/wp-content/themes/occupy_campaigns/library/options/options-css.css" rel="stylesheet" type="text/css" />
		
		
		<style type="text/css" media="print">#wpadminbar { display:none; }</style>
<!-- Vipers Video Quicktags v6.4.2 | http://www.viper007bond.com/wordpress-plugins/vipers-video-quicktags/ -->
<style type="text/css">
.vvqbox { display: block; max-width: 100%; visibility: visible !important; margin: 10px auto; } .vvqbox img { max-width: 100%; height: 100%; } .vvqbox object { max-width: 100%; } 
</style>
<script type="text/javascript">
// <![CDATA[
	var vvqflashvars = {};
	var vvqparams = { wmode: "opaque", allowfullscreen: "true", allowscriptaccess: "always" };
	var vvqattributes = {};
	var vvqexpressinstall = "http://campaigns.occupy.net/wp-content/plugins/vipers-video-quicktags/resources/expressinstall.swf";
// ]]>
</script>
<style type="text/css" media="screen">
	.ep_exclude_alert { font-size: 11px; }
	.new-admin-wp25 { font-size: 11px; background-color: #fff; }
	.new-admin-wp25 .inner {  padding: 8px 12px; background-color: #EAF3FA; border: 1px solid #EAF3FA; -moz-border-radius: 3px; -khtml-border-bottom-radius: 3px; -webkit-border-bottom-radius: 3px; border-bottom-radius: 3px; }
	#ep_admin_meta_box .inner {  padding: inherit; background-color: transparent; border: none; }
	#ep_admin_meta_box .inner label { background-color: none; }
	.new-admin-wp25 .exclude_alert { padding-top: 5px; }
	.new-admin-wp25 .exclude_alert em { font-style: normal; }
</style><style type="text/css">th.column-ws_plugin__wp_show_ids, td.column-ws_plugin__wp_show_ids { width:45px; text-align:center; }</style></head>
<body class="wp-admin no-js  plugin-editor-php admin-bar branch-3-4 version-3-4-1 admin-color-fresh locale-en-us no-customize-support">
<script type="text/javascript">
	document.body.className = document.body.className.replace('no-js','js');
</script>


<div id="wpwrap">

<div id="adminmenuback"></div>
<div id="adminmenuwrap">
<div id="adminmenushadow"></div>
<ul id="adminmenu" role="navigation">


	<li class="wp-first-item wp-not-current-submenu menu-top menu-top-first menu-icon-dashboard menu-top-first" id="menu-dashboard">
	<div class='wp-menu-image'><a href='index.php' aria-label='Dashboard'><br /></a></div><div class="wp-menu-arrow"><div></div></div><a href='index.php' class="wp-first-item wp-not-current-submenu menu-top menu-top-first menu-icon-dashboard menu-top-first" tabindex="1">Dashboard</a></li>
	<li class="wp-has-submenu wp-not-current-submenu menu-top toplevel_page_wpmudev menu-top-last" id="toplevel_page_wpmudev"><div class='wp-menu-image'><a href='admin.php?page=wpmudev' aria-label='WPMU DEV '><img src="http://campaigns.occupy.net/wp-content/plugins/wpmudev-updates/includes/images/icon.png" alt="" /></a></div><div class="wp-menu-arrow"><div></div></div><a href='admin.php?page=wpmudev' class="wp-has-submenu wp-not-current-submenu menu-top toplevel_page_wpmudev menu-top-last" tabindex="1" aria-haspopup="true">WPMU DEV <span class="updates-menu"></span></a>
	<div class='wp-submenu'><div class='wp-submenu-wrap'><div class='wp-submenu-head'>WPMU DEV <span class="updates-menu"></span></div><ul><li class="wp-first-item"><a href='admin.php?page=wpmudev' class="wp-first-item" tabindex="1">Dashboard</a></li><li><a href='admin.php?page=wpmudev-plugins' tabindex="1">Plugins</a></li><li><a href='admin.php?page=wpmudev-themes' tabindex="1">Themes</a></li><li><a href='admin.php?page=wpmudev-support' tabindex="1">Support</a></li><li><a href='admin.php?page=wpmudev-community' tabindex="1">Community</a></li><li><a href='admin.php?page=wpmudev-updates' tabindex="1">Updates <span class="updates-menu"></span></a></li><li><a href='admin.php?page=wpmudev-settings' tabindex="1">Manage</a></li></ul></div></div></li>
	<li class="wp-not-current-submenu wp-menu-separator"><div class="separator"></div></li>
	<li class="wp-has-submenu wp-not-current-submenu menu-top menu-icon-site menu-top-first" id="menu-site">
	<div class='wp-menu-image'><a href='sites.php' aria-label='Sites'><br /></a></div><div class="wp-menu-arrow"><div></div></div><a href='sites.php' class="wp-has-submenu wp-not-current-submenu menu-top menu-icon-site menu-top-first" tabindex="1" aria-haspopup="true">Sites</a>
	<div class='wp-submenu'><div class='wp-submenu-wrap'><div class='wp-submenu-head'>Sites</div><ul><li class="wp-first-item"><a href='sites.php' class="wp-first-item" tabindex="1">All Sites</a></li><li><a href='site-new.php' tabindex="1">Add New</a></li></ul></div></div></li>
	<li class="wp-has-submenu wp-not-current-submenu menu-top menu-icon-users" id="menu-users">
	<div class='wp-menu-image'><a href='users.php' aria-label='Users'><br /></a></div><div class="wp-menu-arrow"><div></div></div><a href='users.php' class="wp-has-submenu wp-not-current-submenu menu-top menu-icon-users" tabindex="1" aria-haspopup="true">Users</a>
	<div class='wp-submenu'><div class='wp-submenu-wrap'><div class='wp-submenu-head'>Users</div><ul><li class="wp-first-item"><a href='users.php' class="wp-first-item" tabindex="1">All Users</a></li><li><a href='user-new.php' tabindex="1">Add New</a></li></ul></div></div></li>
	<li class="wp-has-submenu wp-not-current-submenu menu-top menu-icon-appearance" id="menu-appearance">
	<div class='wp-menu-image'><a href='themes.php' aria-label='Themes'><br /></a></div><div class="wp-menu-arrow"><div></div></div><a href='themes.php' class="wp-has-submenu wp-not-current-submenu menu-top menu-icon-appearance" tabindex="1" aria-haspopup="true">Themes</a>
	<div class='wp-submenu'><div class='wp-submenu-wrap'><div class='wp-submenu-head'>Themes</div><ul><li class="wp-first-item"><a href='themes.php' class="wp-first-item" tabindex="1">Installed Themes</a></li><li><a href='theme-install.php' tabindex="1">Add New</a></li><li><a href='theme-editor.php' tabindex="1">Editor</a></li></ul></div></div></li>
	<li class="wp-has-submenu wp-has-current-submenu wp-menu-open menu-top menu-icon-plugins" id="menu-plugins">
	<div class='wp-menu-image'><a href='plugins.php' aria-label='Plugins 3'><br /></a></div><div class="wp-menu-arrow"><div></div></div><a href='plugins.php' class="wp-has-submenu wp-has-current-submenu wp-menu-open menu-top menu-icon-plugins" tabindex="1">Plugins <span class='update-plugins count-3'><span class='plugin-count'>3</span></span></a>
	<div class='wp-submenu'><div class='wp-submenu-wrap'><div class='wp-submenu-head'>Plugins <span class='update-plugins count-3'><span class='plugin-count'>3</span></span></div><ul><li class="wp-first-item"><a href='plugins.php' class="wp-first-item" tabindex="1">Installed Plugins</a></li><li><a href='plugin-install.php' tabindex="1">Add New</a></li><li class="current"><a href='plugin-editor.php' class="current" tabindex="1">Editor</a></li></ul></div></div></li>
	<li class="wp-has-submenu wp-not-current-submenu menu-top menu-icon-settings" id="menu-settings">
	<div class='wp-menu-image'><a href='settings.php' aria-label='Settings'><br /></a></div><div class="wp-menu-arrow"><div></div></div><a href='settings.php' class="wp-has-submenu wp-not-current-submenu menu-top menu-icon-settings" tabindex="1" aria-haspopup="true">Settings</a>
	<div class='wp-submenu'><div class='wp-submenu-wrap'><div class='wp-submenu-head'>Settings</div><ul><li class="wp-first-item"><a href='settings.php' class="wp-first-item" tabindex="1">Network Settings</a></li><li><a href='setup.php' tabindex="1">Network Setup</a></li><li><a href='settings.php?page=admin-bar-disabler/admin-bar-disabler.php' tabindex="1">Admin Bar Disabler</a></li><li><a href='settings.php?page=blog_templates.php' tabindex="1">Blog Templates</a></li><li><a href='settings.php?page=cets_blog_defaults_management_page' tabindex="1">New Blog Defaults</a></li><li><a href='settings.php?page=domainmapping_options' tabindex="1">Domain Mapping</a></li></ul></div></div></li>
	<li class="wp-has-submenu wp-not-current-submenu menu-top menu-icon-tools menu-top-last" id="menu-update">
	<div class='wp-menu-image'><a href='update-core.php' aria-label='Updates 3'><br /></a></div><div class="wp-menu-arrow"><div></div></div><a href='update-core.php' class="wp-has-submenu wp-not-current-submenu menu-top menu-icon-tools menu-top-last" tabindex="1" aria-haspopup="true">Updates <span class='update-plugins count-3' title='3 Plugin Updates'><span class='update-count'>3</span></span></a>
	<div class='wp-submenu'><div class='wp-submenu-wrap'><div class='wp-submenu-head'>Updates <span class='update-plugins count-3' title='3 Plugin Updates'><span class='update-count'>3</span></span></div><ul><li class="wp-first-item"><a href='update-core.php' class="wp-first-item" tabindex="1">Available Updates</a></li><li><a href='upgrade.php' tabindex="1">Update Network</a></li></ul></div></div></li>
	<li class="wp-not-current-submenu wp-menu-separator-last"><div class="separator"></div></li><li id="collapse-menu" class="hide-if-no-js"><div id="collapse-button"><div></div></div><span>Collapse menu</span></li></ul>
</div>
<div id="wpcontent">

		<div id="wpadminbar" class="nojq nojs" role="navigation">
			<div class="quicklinks">
				<ul id="wp-admin-bar-root-default" class="ab-top-menu">
		<li id="wp-admin-bar-wp-logo" class="menupop"><a class="ab-item" tabindex="10" aria-haspopup="true" href="http://campaigns.occupy.net/wp-admin/network/about.php" title="About WordPress"><span class="ab-icon"></span></a><div class="ab-sub-wrapper"><ul id="wp-admin-bar-wp-logo-default" class="ab-submenu">
		<li id="wp-admin-bar-about" class=""><a class="ab-item" tabindex="10" href="http://campaigns.occupy.net/wp-admin/network/about.php">About WordPress</a>		</li></ul><ul id="wp-admin-bar-wp-logo-external" class="ab-sub-secondary ab-submenu">
		<li id="wp-admin-bar-wporg" class=""><a class="ab-item" tabindex="10" href="http://wordpress.org/">WordPress.org</a>		</li>
		<li id="wp-admin-bar-documentation" class=""><a class="ab-item" tabindex="10" href="http://codex.wordpress.org/">Documentation</a>		</li>
		<li id="wp-admin-bar-support-forums" class=""><a class="ab-item" tabindex="10" href="http://wordpress.org/support/">Support Forums</a>		</li>
		<li id="wp-admin-bar-feedback" class=""><a class="ab-item" tabindex="10" href="http://wordpress.org/support/forum/requests-and-feedback">Feedback</a>		</li></ul></div>		</li>
		<li id="wp-admin-bar-my-sites" class="menupop"><a class="ab-item" tabindex="10" aria-haspopup="true" href="http://campaigns.occupy.net/wp-admin/my-sites.php">My Sites</a><div class="ab-sub-wrapper"><ul id="wp-admin-bar-my-sites-super-admin" class=" ab-submenu">
		<li id="wp-admin-bar-network-admin" class="menupop"><a class="ab-item" tabindex="10" aria-haspopup="true" href="http://campaigns.occupy.net/wp-admin/network/">Network Admin</a><div class="ab-sub-wrapper"><ul id="wp-admin-bar-network-admin-default" class="ab-submenu">
		<li id="wp-admin-bar-network-admin-d" class=""><a class="ab-item" tabindex="10" href="http://campaigns.occupy.net/wp-admin/network/">Dashboard</a>		</li>
		<li id="wp-admin-bar-network-admin-s" class=""><a class="ab-item" tabindex="10" href="http://campaigns.occupy.net/wp-admin/network/sites.php">Sites</a>		</li>
		<li id="wp-admin-bar-network-admin-u" class=""><a class="ab-item" tabindex="10" href="http://campaigns.occupy.net/wp-admin/network/users.php">Users</a>		</li>
		<li id="wp-admin-bar-network-admin-v" class=""><a class="ab-item" tabindex="10" href="http://campaigns.occupy.net/">Visit Network</a>		</li></ul></div>		</li></ul><ul id="wp-admin-bar-my-sites-list" class="ab-sub-secondary ab-submenu">
		<li id="wp-admin-bar-blog-1" class="menupop"><a class="ab-item" tabindex="10" aria-haspopup="true" href="http://campaigns.occupy.net/wp-admin/"><img src="http://campaigns.occupy.net/wp-includes/images/wpmini-blue.png" alt="Blavatar" width="16" height="16" class="blavatar"/>#Occupy Campaigns</a><div class="ab-sub-wrapper"><ul id="wp-admin-bar-blog-1-default" class="ab-submenu">
		<li id="wp-admin-bar-blog-1-d" class=""><a class="ab-item" tabindex="10" href="http://campaigns.occupy.net/wp-admin/">Dashboard</a>		</li>
		<li id="wp-admin-bar-blog-1-n" class=""><a class="ab-item" tabindex="10" href="http://campaigns.occupy.net/wp-admin/post-new.php">New Post</a>		</li>
		<li id="wp-admin-bar-blog-1-c" class=""><a class="ab-item" tabindex="10" href="http://campaigns.occupy.net/wp-admin/edit-comments.php">Manage Comments</a>		</li>
		<li id="wp-admin-bar-blog-1-v" class=""><a class="ab-item" tabindex="10" href="http://campaigns.occupy.net/">Visit Site</a>		</li></ul></div>		</li>
		<li id="wp-admin-bar-blog-15" class="menupop"><a class="ab-item" tabindex="10" aria-haspopup="true" href="http://campaigns.occupy.net/clownbloq/wp-admin/"><img src="http://campaigns.occupy.net/wp-includes/images/wpmini-blue.png" alt="Blavatar" width="16" height="16" class="blavatar"/>We are #ClownBloq</a><div class="ab-sub-wrapper"><ul id="wp-admin-bar-blog-15-default" class="ab-submenu">
		<li id="wp-admin-bar-blog-15-d" class=""><a class="ab-item" tabindex="10" href="http://campaigns.occupy.net/clownbloq/wp-admin/">Dashboard</a>		</li>
		<li id="wp-admin-bar-blog-15-n" class=""><a class="ab-item" tabindex="10" href="http://campaigns.occupy.net/clownbloq/wp-admin/post-new.php">New Post</a>		</li>
		<li id="wp-admin-bar-blog-15-c" class=""><a class="ab-item" tabindex="10" href="http://campaigns.occupy.net/clownbloq/wp-admin/edit-comments.php">Manage Comments</a>		</li>
		<li id="wp-admin-bar-blog-15-v" class=""><a class="ab-item" tabindex="10" href="http://campaigns.occupy.net/clownbloq/">Visit Site</a>		</li></ul></div>		</li>
		<li id="wp-admin-bar-blog-16" class="menupop"><a class="ab-item" tabindex="10" aria-haspopup="true" href="http://campaigns.occupy.net/internpower/wp-admin/"><img src="http://campaigns.occupy.net/wp-includes/images/wpmini-blue.png" alt="Blavatar" width="16" height="16" class="blavatar"/>Intern Power</a><div class="ab-sub-wrapper"><ul id="wp-admin-bar-blog-16-default" class="ab-submenu">
		<li id="wp-admin-bar-blog-16-d" class=""><a class="ab-item" tabindex="10" href="http://campaigns.occupy.net/internpower/wp-admin/">Dashboard</a>		</li>
		<li id="wp-admin-bar-blog-16-n" class=""><a class="ab-item" tabindex="10" href="http://campaigns.occupy.net/internpower/wp-admin/post-new.php">New Post</a>		</li>
		<li id="wp-admin-bar-blog-16-c" class=""><a class="ab-item" tabindex="10" href="http://campaigns.occupy.net/internpower/wp-admin/edit-comments.php">Manage Comments</a>		</li>
		<li id="wp-admin-bar-blog-16-v" class=""><a class="ab-item" tabindex="10" href="http://campaigns.occupy.net/internpower/">Visit Site</a>		</li></ul></div>		</li>
		<li id="wp-admin-bar-blog-18" class="menupop"><a class="ab-item" tabindex="10" aria-haspopup="true" href="http://campaigns.occupy.net/s17/wp-admin/"><img src="http://campaigns.occupy.net/wp-includes/images/wpmini-blue.png" alt="Blavatar" width="16" height="16" class="blavatar"/>S17</a><div class="ab-sub-wrapper"><ul id="wp-admin-bar-blog-18-default" class="ab-submenu">
		<li id="wp-admin-bar-blog-18-d" class=""><a class="ab-item" tabindex="10" href="http://campaigns.occupy.net/s17/wp-admin/">Dashboard</a>		</li>
		<li id="wp-admin-bar-blog-18-n" class=""><a class="ab-item" tabindex="10" href="http://campaigns.occupy.net/s17/wp-admin/post-new.php">New Post</a>		</li>
		<li id="wp-admin-bar-blog-18-c" class=""><a class="ab-item" tabindex="10" href="http://campaigns.occupy.net/s17/wp-admin/edit-comments.php">Manage Comments</a>		</li>
		<li id="wp-admin-bar-blog-18-v" class=""><a class="ab-item" tabindex="10" href="http://campaigns.occupy.net/s17/">Visit Site</a>		</li></ul></div>		</li>
		<li id="wp-admin-bar-blog-19" class="menupop"><a class="ab-item" tabindex="10" aria-haspopup="true" href="http://campaigns.occupy.net/studentdebtpledge/wp-admin/"><img src="http://campaigns.occupy.net/wp-includes/images/wpmini-blue.png" alt="Blavatar" width="16" height="16" class="blavatar"/>Student Debt Pledge</a><div class="ab-sub-wrapper"><ul id="wp-admin-bar-blog-19-default" class="ab-submenu">
		<li id="wp-admin-bar-blog-19-d" class=""><a class="ab-item" tabindex="10" href="http://campaigns.occupy.net/studentdebtpledge/wp-admin/">Dashboard</a>		</li>
		<li id="wp-admin-bar-blog-19-n" class=""><a class="ab-item" tabindex="10" href="http://campaigns.occupy.net/studentdebtpledge/wp-admin/post-new.php">New Post</a>		</li>
		<li id="wp-admin-bar-blog-19-c" class=""><a class="ab-item" tabindex="10" href="http://campaigns.occupy.net/studentdebtpledge/wp-admin/edit-comments.php">Manage Comments</a>		</li>
		<li id="wp-admin-bar-blog-19-v" class=""><a class="ab-item" tabindex="10" href="http://campaigns.occupy.net/studentdebtpledge/">Visit Site</a>		</li></ul></div>		</li></ul></div>		</li>
		<li id="wp-admin-bar-site-name" class="menupop"><a class="ab-item" tabindex="10" aria-haspopup="true" href="http://campaigns.occupy.net/">Network Admin: Campaigns Sites</a><div class="ab-sub-wrapper"><ul id="wp-admin-bar-site-name-default" class="ab-submenu">
		<li id="wp-admin-bar-view-site" class=""><a class="ab-item" tabindex="10" href="http://campaigns.occupy.net/">Visit Site</a>		</li></ul></div>		</li>
		<li id="wp-admin-bar-updates" class=""><a class="ab-item" tabindex="10" href="http://campaigns.occupy.net/wp-admin/network/update-core.php" title="3 Plugin Updates"><span class="ab-icon"></span><span class="ab-label">3</span></a>		</li></ul><ul id="wp-admin-bar-top-secondary" class="ab-top-secondary ab-top-menu">
		<li id="wp-admin-bar-my-account" class="menupop with-avatar"><a class="ab-item" tabindex="10" aria-haspopup="true" href="http://campaigns.occupy.net/wp-admin/network/profile.php" title="My Account">Howdy, Pea<img alt='' src='http://1.gravatar.com/avatar/f7f09f7d1bc15b49712bbcfde6a2625b?s=16&amp;d=http%3A%2F%2F1.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D16&amp;r=G' class='avatar avatar-16 photo' height='16' width='16' /></a><div class="ab-sub-wrapper"><ul id="wp-admin-bar-user-actions" class=" ab-submenu">
		<li id="wp-admin-bar-user-info" class=""><a class="ab-item" tabindex="-1" href="http://campaigns.occupy.net/wp-admin/network/profile.php"><img alt='' src='http://1.gravatar.com/avatar/f7f09f7d1bc15b49712bbcfde6a2625b?s=64&amp;d=http%3A%2F%2F1.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D64&amp;r=G' class='avatar avatar-64 photo' height='64' width='64' /><span class='display-name'>Pea</span><span class='username'>patricia</span></a>		</li>
		<li id="wp-admin-bar-edit-profile" class=""><a class="ab-item" tabindex="10" href="http://campaigns.occupy.net/wp-admin/network/profile.php">Edit My Profile</a>		</li>
		<li id="wp-admin-bar-logout" class=""><a class="ab-item" tabindex="10" href="http://campaigns.occupy.net/wp-login.php?action=logout&#038;_wpnonce=a35a1e0572">Log Out</a>		</li></ul></div>		</li></ul>			</div>
		</div>

		
<div id="wpbody">

<div id="wpbody-content">
		<div id="screen-meta" class="metabox-prefs">

			<div id="contextual-help-wrap" class="hidden">
				<div id="contextual-help-back"></div>
				<div id="contextual-help-columns">
					<div class="contextual-help-tabs">
						<ul>
						
							<li id="tab-link-overview" class="active">
								<a href="#tab-panel-overview">
									Overview								</a>
							</li>
												</ul>
					</div>

										<div class="contextual-help-sidebar">
						<p><strong>For more information:</strong></p><p><a href="http://codex.wordpress.org/Plugins_Editor_Screen" target="_blank">Documentation on Editing Plugins</a></p><p><a href="http://codex.wordpress.org/Writing_a_Plugin" target="_blank">Documentation on Writing Plugins</a></p><p><a href="http://wordpress.org/support/" target="_blank">Support Forums</a></p>					</div>
					
					<div class="contextual-help-tabs-wrap">
						
							<div id="tab-panel-overview" class="help-tab-content active">
								<p>You can use the editor to make changes to any of your plugins&#8217; individual PHP files. Be aware that if you make changes, plugins updates will overwrite your customizations.</p><p>Choose a plugin to edit from the menu in the upper right and click the Select button. Click once on any file name to load it in the editor, and make your changes. Don&#8217;t forget to save your changes (Update File) when you&#8217;re finished.</p><p>The Documentation menu below the editor lists the PHP functions recognized in the plugin file. Clicking Lookup takes you to a web page about that particular function.</p><p>If you want to make changes but don&#8217;t want them to be overwritten when the plugin is updated, you may be ready to think about writing your own plugin. For information on how to edit plugins, write your own from scratch, or just better understand their anatomy, check out the links below.</p><p>Any edits to files from this screen will be reflected on all sites in the network.</p>							</div>
											</div>
				</div>
			</div>
				</div>
				<div id="screen-meta-links">
					<div id="contextual-help-link-wrap" class="hide-if-no-js screen-meta-toggle">
			<a href="#contextual-help-wrap" id="contextual-help-link" class="show-settings">Help</a>
			</div>
				</div>
		<div class="wrap">
<div id="icon-plugins" class="icon32"><br /></div><h2>Edit Plugins</h2>

<div class="fileedit-sub">
<div class="alignleft">
<big>Editing <strong>bp-group-calendar/groupcalendar/bp-group-calendar.php</strong> (inactive)</big>
</div>
<div class="alignright">
	<form action="plugin-editor.php" method="post">
		<strong><label for="plugin">Select plugin to edit: </label></strong>
		<select name="plugin" id="plugin">

	<option value="ab-theme-testing/ab-theme-testing.php" >A/B Theme Testing Plugin</option>
	<option value="admin-bar-disabler/admin-bar-disabler.php" >Admin Bar Disabler</option>
	<option value="admin-menu-editor/menu-editor.php" >Admin Menu Editor</option>
	<option value="all-in-one-event-calendar/all-in-one-event-calendar.php" >All-in-One Event Calendar</option>
	<option value="blogs-and-users/blogs-and-users.php" >Blogs And Users</option>
	<option value="bp-group-calendar/loader.php" >BuddyPress Group Calendar</option>
	<option value="wpmu-new-blog-defaults/cets_blog_defaults.php" >cets_blog_defaults</option>
	<option value="comments-plus/comments-plus.php" >Comments Plus</option>
	<option value="custom-login-logo-lite/custom-login-logo-lite.php" >Custom Login Logo Lite</option>
	<option value="display-widgets/display-widgets.php" >Display widgets</option>
	<option value="domain-mapping/domain-mapping.php" >Domain Mapping plugin</option>
	<option value="easyblogging/easyblogging.php" >Easy Blogging</option>
	<option value="exclude-pages/exclude_pages.php" >Exclude Pages from Navigation</option>
	<option value="feedwordpress/feedwordpress.php" >FeedWordPress</option>
	<option value="friends/friends.php" >Friends</option>
	<option value="pagelines-googlefonts/pagelines-googlefonts.php" >Googlefonts</option>
	<option value="wpmu_dev_maps_plugin/wpmu_dev_maps_plugin.php" >Google Maps</option>
	<option value="gravityforms/gravityforms.php" >Gravity Forms</option>
	<option value="pagelines-lazyloader/pagelines-lazyloader.php" >LazyLoader</option>
	<option value="login-with-ajax/login-with-ajax.php" >Login With Ajax</option>
	<option value="members/members.php" >Members</option>
	<option value="moderation/moderation.php" >Moderation</option>
	<option value="my-category-order/mycategoryorder.php" >My Category Order</option>
	<option value="my-link-order/mylinkorder.php" >My Link Order</option>
	<option value="my-page-order/mypageorder.php" >My Page Order</option>
	<option value="blogtemplates/blogtemplates.php" >New Blog Templates</option>
	<option value="pagelines-sections/pagelines-sections.php" >Pagelines Sections</option>
	<option value="page-links-to/page-links-to.php" >Page Links To</option>
	<option value="portable-phpmyadmin/wp-phpmyadmin.php" >Portable phpMyAdmin</option>
	<option value="wpmu-dev-post-votes/wpmu-dev-post-votes.php" >Post Voting</option>
	<option value="q-and-a/q-and-a.php" >Q and A</option>
	<option value="relevanssi/relevanssi.php" >Relevanssi</option>
	<option value="responsive-slider/responsive-slider.php" >Responsive Slider</option>
	<option value="scheduled-content/scheduled-content.php" >Scheduled Content</option>
	<option value="shortcodes-ultimate/shortcodes-ultimate.php" >Shortcodes Ultimate</option>
	<option value="si-captcha-for-wordpress/si-captcha.php" >SI CAPTCHA Anti-Spam</option>
	<option value="signup-tos/signup-tos.php" >Signup TOS</option>
	<option value="simple-sitemaps/simple-sitemaps.php" >Simple Sitemaps For Multisite</option>
	<option value="quick-status/quick-status.php" >Status</option>
	<option value="subscribe-connect-follow-widget/subscribe-connect-follow-widget.php" >Subscribe / Connect / Follow Widget</option>
	<option value="theme-visibility-manager/themes-visibility-manager.php" >Themes Visibility Manager</option>
	<option value="types/wpcf.php" >Types - Complete Solution for Custom Fields and Types</option>
	<option value="unfiltered-mu/unfiltered-mu.php" >Unfiltered MU</option>
	<option value="videoshowcase/videoshowcase.php" >Video Showcase</option>
	<option value="vipers-video-quicktags/vipers-video-quicktags.php" >Viper&#039;s Video Quicktags</option>
	<option value="safecss/safecss.php" >WordPress.com Custom CSS</option>
	<option value="font-uploader/font-uploader.php" >Wordpress Font Uploader</option>
	<option value="wordpress-importer/wordpress-importer.php" >WordPress Importer</option>
	<option value="wp-piwik/wp-piwik.php" >WP-Piwik</option>
	<option value="wp-better-emails/wpbe.php" >WP Better Emails</option>
	<option value="wpmudev-updates/update-notifications.php" >WPMU DEV Dashboard</option>
	<option value="wp-show-ids/wp-show-ids.php" >WP Show IDs</option>
	<option value="wp-views/wp-views.php" >WP Views</option>		</select>
		<input type="submit" name="Submit" id="Submit" class="button" value="Select"  />	</form>
</div>
<br class="clear" />
</div>

<div id="templateside">
	<h3>Plugin Files</h3>

	<ul>
		<li class="highlight"><a href="plugin-editor.php?file=bp-group-calendar%2Fgroupcalendar%2Fbp-group-calendar.php&amp;plugin=bp-group-calendar%2Fgroupcalendar%2Fbp-group-calendar.php">bp-group-calendar/groupcalendar/bp-group-calendar.php</a></li>
		<li><a href="plugin-editor.php?file=bp-group-calendar%2Fgroupcalendar%2Fcalendar.class.php&amp;plugin=bp-group-calendar%2Fgroupcalendar%2Fbp-group-calendar.php">bp-group-calendar/groupcalendar/calendar.class.php</a></li>
		<li><a href="plugin-editor.php?file=bp-group-calendar%2Fgroupcalendar%2Fgroup_calendar.css&amp;plugin=bp-group-calendar%2Fgroupcalendar%2Fbp-group-calendar.php">bp-group-calendar/groupcalendar/group_calendar.css</a></li>
	</ul>
</div>
<form name="template" id="template" action="plugin-editor.php" method="post">
	<input type="hidden" id="_wpnonce" name="_wpnonce" value="4b6b9d9655" /><input type="hidden" name="_wp_http_referer" value="/wp-admin/network/plugin-editor.php?file=bp-group-calendar%2Fgroupcalendar%2Fbp-group-calendar.php&amp;plugin=bp-group-calendar%2Floader.php" />		<div><textarea cols="70" rows="25" name="newcontent" id="newcontent" tabindex="1">&lt;?php
/*
Plugin Name: BP Group Calendar
*/

//------------------------------------------------------------------------//

//---Config---------------------------------------------------------------//

//------------------------------------------------------------------------//

//include calendar class
require_once(WP_PLUGIN_DIR . &#039;/bp-group-calendar/groupcalendar/calendar.class.php&#039;);

//------------------------------------------------------------------------//

//---Hook-----------------------------------------------------------------//

//------------------------------------------------------------------------//

//check for activating

add_action(&#039;admin_init&#039;, &#039;bp_group_calendar_make_current&#039;);


add_action( &#039;groups_group_after_save&#039;, &#039;bp_group_calendar_settings_save&#039; );
add_action( &#039;bp_after_group_settings_creation_step&#039;, &#039;bp_group_calendar_settings&#039;);
add_action( &#039;bp_after_group_settings_admin&#039;, &#039;bp_group_calendar_settings&#039;);
add_action( &#039;wp_head&#039;, &#039;bp_group_calendar_css_output&#039;);
add_action( &#039;groups_screen_notification_settings&#039;, &#039;bp_group_calendar_notification_settings&#039; );

//activity stream
add_action( &#039;groups_register_activity_actions&#039;, &#039;bp_group_calendar_reg_activity&#039; );
add_action( &#039;groups_new_calendar_event&#039;, &#039;groups_update_last_activity&#039; );
add_action( &#039;groups_edit_calendar_event&#039;, &#039;groups_update_last_activity&#039; );


//widgets
add_action( &#039;widgets_init&#039;, create_function(&#039;&#039;, &#039;return register_widget(&quot;BP_Group_Calendar_Widget&quot;);&#039;) );
add_action( &#039;widgets_init&#039;, create_function(&#039;&#039;, &#039;return register_widget(&quot;BP_Group_Calendar_Widget_Single&quot;);&#039;) );
add_action( &#039;widgets_init&#039;, create_function(&#039;&#039;, &#039;return register_widget(&quot;BP_Group_Calendar_Widget_User_Groups&quot;);&#039;) );

//------------------------------------------------------------------------//

//---Functions------------------------------------------------------------//

//------------------------------------------------------------------------//



function bp_group_calendar_make_current() {

	global $wpdb, $bp_group_calendar_current_version;

	if (get_site_option( &quot;bp_group_calendar_version&quot; ) == &#039;&#039;) {
		add_site_option( &#039;bp_group_calendar_version&#039;, &#039;0.0.0&#039; );
	}

	if (get_site_option( &quot;bp_group_calendar_version&quot; ) == $bp_group_calendar_current_version) {
		// do nothing
	} else {
		//update to current version
		update_site_option( &quot;bp_group_calendar_installed&quot;, &quot;no&quot; );
		update_site_option( &quot;bp_group_calendar_version&quot;, $bp_group_calendar_current_version );
	}
	bp_group_calendar_global_install();
}


function bp_group_calendar_global_install() {

	global $wpdb, $bp_group_calendar_current_version;

	if (get_site_option( &quot;bp_group_calendar_installed&quot; ) == &#039;&#039;) {
		add_site_option( &#039;bp_group_calendar_installed&#039;, &#039;no&#039; );
	}

	if (get_site_option( &quot;bp_group_calendar_installed&quot; ) == &quot;yes&quot;) {
		// do nothing
	} else {
		$bp_group_calendar_table1 = &quot;CREATE TABLE IF NOT EXISTS `&quot; . $wpdb-&gt;base_prefix . &quot;bp_groups_calendars` (
                                  `id` bigint(20) unsigned NOT NULL auto_increment,
                                  `group_id` bigint(20) NOT NULL default &#039;0&#039;,
                                  `user_id` bigint(20) NOT NULL default &#039;0&#039;,
                                  `event_time` DATETIME NOT NULL,
                                  `event_title` TEXT NOT NULL,
                                  `event_description` TEXT,
                                  `event_location` TEXT,
                                  `event_map` BOOL NOT NULL,
                                  `created_stamp` bigint(30) NOT NULL,
                                  `last_edited_id` bigint(20) NOT NULL default &#039;0&#039;,
                                  `last_edited_stamp` bigint(30) NOT NULL,
                                  PRIMARY KEY  (`id`)                              
                                ) ENGINE=MyISAM CHARACTER SET utf8 COLLATE utf8_general_ci;&quot;;

		$wpdb-&gt;query( $bp_group_calendar_table1 );
		update_site_option( &quot;bp_group_calendar_installed&quot;, &quot;yes&quot; );
	}
}

//extend the group
class BP_Group_Calendar_Extension extends BP_Group_Extension {

	var $visibility = &#039;private&#039;; // &#039;public&#039; will show your extension to non-group members, &#039;private&#039; means you have to be a member of the group to view your extension.
	var $enable_create_step = false; // If your extension does not need a creation step, set this to false
	var $enable_nav_item = false; // If your extension does not need a navigation item, set this to false
	var $enable_edit_item = false; // If your extension does not need an edit screen, set this to false

	function bp_group_calendar_extension() {
		global $bp;

		$this-&gt;name = __(&#039;Calendar&#039;, &#039;groupcalendar&#039;);
		$this-&gt;slug = &#039;calendar&#039;;
		$this-&gt;enable_nav_item = $bp-&gt;groups-&gt;current_group-&gt;user_has_access;

		//$this-&gt;create_step_position = 21;
		$this-&gt;nav_item_position = 36;

	}

	function create_screen() { }

	function create_screen_save() { }

	function edit_screen() { }

	function edit_screen_save() {	}

	function display() {
		global $bp;
		$event_id = bp_group_calendar_event_url_parse();

		$edit_event = bp_group_calendar_event_is_edit();

		bp_group_calendar_event_is_delete();

		if (bp_group_calendar_event_save()===false)
			$edit_event = true;

		$date = bp_group_calendar_url_parse();

		do_action( &#039;template_notices&#039; );

		if ($edit_event) {

			//show edit event form
			if (!bp_group_calendar_widget_edit_event($event_id)) {

				//default to current month view
				bp_group_calendar_widget_month($date);
				bp_group_calendar_widget_upcoming_events();
				bp_group_calendar_widget_my_events();
				bp_group_calendar_widget_create_event($date);

			}

		} else if ($event_id) {

			//display_event
			bp_group_calendar_widget_event_display($event_id);

			//current month view
			bp_group_calendar_widget_month($date);

		} else if ( isset($date[&#039;year&#039;]) &amp;&amp; !isset($date[&#039;month&#039;]) &amp;&amp; !isset($date[&#039;day&#039;]) ) {

			//year view
			bp_group_calendar_widget_year($date);

			bp_group_calendar_widget_create_event($date);

		} else if ( isset($date[&#039;year&#039;]) &amp;&amp; isset($date[&#039;month&#039;]) &amp;&amp; !isset($date[&#039;day&#039;]) ) {

			//month view
			bp_group_calendar_widget_month($date);

			bp_group_calendar_widget_create_event($date);

		} else if ( isset($date[&#039;year&#039;]) &amp;&amp; isset($date[&#039;month&#039;]) &amp;&amp; isset($date[&#039;day&#039;]) ) {

			//day view
			bp_group_calendar_widget_day($date);

			bp_group_calendar_widget_create_event($date);

		} else {

			//default to current month view
			bp_group_calendar_widget_month($date);

			bp_group_calendar_widget_upcoming_events();

			bp_group_calendar_widget_my_events();

			bp_group_calendar_widget_create_event($date);

		}
	}

	function widget_display() {
		bp_group_calendar_widget_upcoming_events();
	}
}
bp_register_group_extension( &#039;BP_Group_Calendar_Extension&#039; );


function bp_group_calendar_settings_save($group) {
	global $wpdb;

	if ( isset($_POST[&#039;group-calendar-moderator-capabilities&#039;]) ) {
		groups_update_groupmeta( $group-&gt;id, &#039;group_calendar_moderator_capabilities&#039;, $_POST[&#039;group-calendar-moderator-capabilities&#039;]);
	}

	if ( isset($_POST[&#039;group-calendar-member-capabilities&#039;]) ) {
		groups_update_groupmeta( $group-&gt;id, &#039;group_calendar_member_capabilities&#039;, $_POST[&#039;group-calendar-member-capabilities&#039;]);
	}

	if ( isset($_POST[&#039;group-calendar-send-email&#039;]) ) {
		groups_update_groupmeta( $group-&gt;id, &#039;group_calendar_send_email&#039;, $_POST[&#039;group-calendar-send-email&#039;]);
	}
}


function bp_group_calendar_event_save() {
	global $wpdb, $current_user;

	$calendar_capabilities = bp_group_calendar_get_capabilities();

	if (isset($_POST[&#039;create-event&#039;])) {
		if (!wp_verify_nonce($_REQUEST[&#039;_wpnonce&#039;], &#039;bp_group_calendar&#039;)) {
			bp_core_add_message( __(&#039;There was a security problem&#039;, &#039;groupcalendar&#039;), &#039;error&#039; );
			return false;
		}

		//reject unqualified users
		if ($calendar_capabilities == &#039;none&#039;) {
			bp_core_add_message( __(&quot;You don&#039;t have permission to edit events&quot;, &#039;groupcalendar&#039;), &#039;error&#039; );
			return false;
		}

		//prepare fields
		$group_id = (int)$_POST[&#039;group-id&#039;];
		$event_title = esc_attr(strip_tags(trim($_POST[&#039;event-title&#039;])));

		//check that required title isset after filtering
		if (empty($event_title)) {
			bp_core_add_message( __(&quot;An event title is required&quot;, &#039;groupcalendar&#039;), &#039;error&#039; );
			return false;
		}

		$tmp_date = $_POST[&#039;event-date&#039;].&#039; &#039;.$_POST[&#039;event-hour&#039;].&#039;:&#039;.$_POST[&#039;event-minute&#039;].$_POST[&#039;event-ampm&#039;];
		$tmp_date = strtotime($tmp_date);
		//check for valid date/time
		if ($tmp_date &amp;&amp; strtotime($_POST[&#039;event-date&#039;]) &amp;&amp; strtotime($_POST[&#039;event-date&#039;]) != -1) {
			$event_date = date_i18n(&#039;Y-m-d H:i:s&#039;, $tmp_date);
		} else {
			bp_core_add_message( __(&quot;Please enter a valid event date.&quot;, &#039;groupcalendar&#039;), &#039;error&#039; );
			return false;
		}

		$event_description = wp_filter_post_kses(wpautop($_POST[&#039;event-desc&#039;]));
		$event_location = esc_attr(strip_tags(trim($_POST[&#039;event-loc&#039;])));
		$event_map = ($_POST[&#039;event-map&#039;]==1) ? 1 : 0;

		//editing previous event
		if (isset($_POST[&#039;event-id&#039;])) {

			//can user modify this event?
			if ($calendar_capabilities == &#039;limited&#039;) {
				$creator_id = $wpdb-&gt;get_var(&quot;SELECT user_id FROM &quot; . $wpdb-&gt;base_prefix . &quot;bp_groups_calendars WHERE id = &quot;.(int)$_POST[&#039;event-id&#039;].&quot; AND group_id = $group_id&quot;);

				if ($creator_id != $current_user-&gt;ID) {
					bp_core_add_message( __(&quot;You don&#039;t have permission to edit that event&quot;, &#039;groupcalendar&#039;), &#039;error&#039; );
					return false;
				}
			}

			$query = $wpdb-&gt;prepare(&quot;UPDATE &quot; . $wpdb-&gt;base_prefix . &quot;bp_groups_calendars
                            	SET event_time = %s, event_title = %s, event_description = %s, event_location = %s, event_map = %d, last_edited_id = %d, last_edited_stamp = %d 
                            	WHERE id = %d AND group_id = %d LIMIT 1&quot;, 
			$event_date, $event_title, $event_description, $event_location, $event_map, $current_user-&gt;ID, time(), (int)$_POST[&#039;event-id&#039;], $group_id );

			if ($wpdb-&gt;query($query)) {
				bp_core_add_message( __(&quot;Event saved&quot;, &#039;groupcalendar&#039;) );

				//record activity
				bp_group_calendar_event_add_action_message(false, (int)$_POST[&#039;event-id&#039;], $event_date, $event_title);

				return true;
			} else {
				bp_core_add_message( __(&quot;There was a problem saving to the DB&quot;, &#039;groupcalendar&#039;), &#039;error&#039; );
				return false;
			}

		} else { //new event

			$query = $wpdb-&gt;prepare(&quot;INSERT INTO &quot; . $wpdb-&gt;base_prefix . &quot;bp_groups_calendars
                            	( group_id, user_id, event_time, event_title, event_description, event_location, event_map, created_stamp, last_edited_id, last_edited_stamp )
                            	VALUES ( %d, %d, %s, %s, %s, %s, %d, %d, %d, %d )&quot;, 
			$group_id, $current_user-&gt;ID, $event_date, $event_title, $event_description, $event_location, $event_map, time(), $current_user-&gt;ID, time() );

			if ($wpdb-&gt;query($query)) {
				bp_core_add_message( __(&quot;Event saved&quot;, &#039;groupcalendar&#039;) );
				bp_group_calendar_event_add_action_message(true, $wpdb-&gt;insert_id, $event_date, $event_title);

				//email group members
				bp_group_calendar_event_email(true, $wpdb-&gt;insert_id, $event_date, $event_title);

				return true;
			} else {
				bp_core_add_message( __(&quot;There was a problem saving to the DB&quot;, &#039;groupcalendar&#039;), &#039;error&#039; );
				return false;
			}

		}

	}
}

//register activities
function bp_group_calendar_reg_activity() {
	global $bp;
	bp_activity_set_action( $bp-&gt;groups-&gt;id, &#039;new_calendar_event&#039;, __( &#039;New group event&#039;, &#039;groupcalendar&#039; ) );
	bp_activity_set_action( $bp-&gt;groups-&gt;id, &#039;edit_calendar_event&#039;, __( &#039;Modified group event&#039;, &#039;groupcalendar&#039; ) );
}

//adds actions to the group recent actions
function bp_group_calendar_event_add_action_message($new, $event_id, $event_date, $event_title) {
	global $bp;

	$url = bp_group_calendar_create_event_url($event_id);

	if ($new) {
		$created_type = __(&#039;created&#039;, &#039;groupcalendar&#039;);
		$component_action = &#039;new_calendar_event&#039;;
	} else {
		$created_type = __(&#039;modified&#039;, &#039;groupcalendar&#039;);
		$component_action = &#039;edit_calendar_event&#039;;
	}

	$date = date_i18n(get_option(&#039;date_format&#039;).&#039; &#039;.get_option(&#039;time_format&#039;), strtotime($event_date));

	/* Record this in group activity stream */
	$action = sprintf( __( &#039;%s %s an event for the group %s:&#039;, &#039;groupcalendar&#039;), bp_core_get_userlink( $bp-&gt;loggedin_user-&gt;id ), $created_type, &#039;&lt;a href=&quot;&#039; . bp_get_group_permalink( $bp-&gt;groups-&gt;current_group ) . &#039;&quot;&gt;&#039; . esc_attr( $bp-&gt;groups-&gt;current_group-&gt;name ) . &#039;&lt;/a&gt;&#039; );
	$content = &#039;&lt;a href=&quot;&#039;.$url.&#039;&quot; title=&quot;&#039;.__(&#039;View Event&#039;, &#039;groupcalendar&#039;).&#039;&quot;&gt;&#039;.$date.&#039;:&#039;.stripslashes($event_title).&#039;&lt;/a&gt;&#039;;

	$activity_id = groups_record_activity( array(
	&#039;action&#039; =&gt; $action,
	&#039;content&#039; =&gt; $content,
	&#039;primary_link&#039; =&gt; $url,
	&#039;type&#039; =&gt; $component_action,
	&#039;item_id&#039; =&gt; $bp-&gt;groups-&gt;current_group-&gt;id,
	&#039;secondary_item_id&#039; =&gt; $event_id
	) );

	//update group last updated
	groups_update_last_activity( $bp-&gt;groups-&gt;current_group-&gt;id );
	do_action( &#039;bp_groups_posted_update&#039;, $content, get_current_user_id(), $bp-&gt;groups-&gt;current_group-&gt;id, $activity_id );

}

//send the email
function bp_group_calendar_event_email($new, $event_id, $event_date, $event_title) {
	global $wpdb, $current_user, $bp, $bgc_email_default;

	//check if email is disabled for group
	$email = groups_get_groupmeta($bp-&gt;groups-&gt;current_group-&gt;id, &#039;group_calendar_send_email&#039;);
	if ( empty( $email ) ){
		$email = BGC_EMAIL_DEFAULT;
	}
	if ($email == &#039;no&#039;)
	return;

	//prepare fields
	$date = date_i18n(get_option(&#039;date_format&#039;).&#039; &#039;.get_option(&#039;time_format&#039;), strtotime($event_date));
	$url = bp_group_calendar_create_event_url($event_id);
	$site_name = get_blog_option( BP_ROOT_BLOG, &#039;blogname&#039; );
	$email_subject = sprintf( __( &#039;%s created a new event for your group %s&#039;, &#039;groupcalendar&#039;), bp_core_get_userlink( $bp-&gt;loggedin_user-&gt;id, true ), $bp-&gt;groups-&gt;current_group-&gt;name);
	$event_description = strip_tags(stripslashes($_POST[&#039;event-desc&#039;]));
	$location = strip_tags(trim(stripslashes($_POST[&#039;event-loc&#039;])));

	//send emails
	$group_link = trailingslashit( bp_get_group_permalink( $bp-&gt;groups-&gt;current_group ) );

	$user_ids = BP_Groups_Member::get_group_member_ids($bp-&gt;groups-&gt;current_group-&gt;id);

	foreach ($user_ids as $user_id) {
		//skip opt-outs
		if ( &#039;no&#039; == get_usermeta( $user_id, &#039;notification_groups_calendar_event&#039; ) )
		continue;

		$ud = get_userdata( $user_id );

		// Set up and send the message
		$to = $ud-&gt;user_email;

		$settings_link = bp_core_get_user_domain( $user_id ) . &#039;settings/notifications/&#039;;

		$message = sprintf( __(
		&quot;%s:
---------------------

%s
%s

Description:
%s

Location:
%s

---------------------
View this Event: %s
View this Group: %s

%s
&quot;, &#039;groupcalendar&#039; ), $email_subject, stripslashes($event_title), $date, $event_description, $location, $url, $group_link, $site_name );

		$message .= sprintf( __( &#039;To unsubscribe from these emails please login and visit: %s&#039;, &#039;groupcalendar&#039; ), $settings_link );

		// Send it
		wp_mail( $to, $email_subject, $message );

		unset( $message, $to );
	}

}

function bp_group_calendar_get_capabilities() {
	global $bp;

	if ( bp_group_is_admin() ) {
		return &#039;full&#039;;
	} else if ( bp_group_is_mod() ) {

		$group_calendar_moderator_capabilities = groups_get_groupmeta( $bp-&gt;groups-&gt;current_group-&gt;id, &#039;group_calendar_moderator_capabilities&#039; );
		if ( empty( $group_calendar_moderator_capabilities ) ){
			return BGC_MODERATOR_DEFAULT;
		} else {
			return $group_calendar_moderator_capabilities;
		}

	} else if ( bp_group_is_member() ) {

		$group_calendar_member_capabilities = groups_get_groupmeta( $bp-&gt;groups-&gt;current_group-&gt;id, &#039;group_calendar_member_capabilities&#039; );
		if ( empty( $group_calendar_member_capabilities ) ){
			return BGC_MEMBER_DEFAULT;
		} else {
			return $group_calendar_member_capabilities;
		}

	} else {
		return &#039;none&#039;;
	}

}

function bp_group_calendar_url_parse() {

	global $wpdb, $current_site;

	$calendar_url = $_SERVER[&#039;REQUEST_URI&#039;];

	$calendar_url_clean = explode(&quot;?&quot;,$calendar_url);

	$calendar_url = $calendar_url_clean[0];

	$calendar_url_sections = explode(&quot;/calendar/&quot;,$calendar_url);

	$calendar_url = $calendar_url_sections[1];

	$calendar_url = ltrim($calendar_url, &quot;/&quot;);

	$calendar_url = rtrim($calendar_url, &quot;/&quot;);

	$base = $calendar_url_sections[0] . &#039;/calendar/&#039;;

	$base = ltrim($base, &quot;/&quot;);

	$base = rtrim($base, &quot;/&quot;);

	if ( !empty( $calendar_url ) ) {

		$calendar_url = ltrim($calendar_url, &quot;/&quot;);
		$calendar_url = rtrim($calendar_url, &quot;/&quot;);
		$calendar_url_sections = explode(&quot;/&quot;,$calendar_url);

		//check for valid dates.
		if (isset($calendar_url_sections[0]) &amp;&amp; $calendar_url_sections[0] &gt;= 2000 &amp;&amp; $calendar_url_sections[0] &lt; 3000)
		$date[&#039;year&#039;] = (int)$calendar_url_sections[0];

		if (isset($date[&#039;year&#039;]) &amp;&amp; isset($calendar_url_sections[1]) &amp;&amp; $calendar_url_sections[1] &gt;= 1 &amp;&amp; $calendar_url_sections[1] &lt;= 12)
		$date[&#039;month&#039;] = (int)$calendar_url_sections[1];

		if (isset($date[&#039;month&#039;]) &amp;&amp; isset($calendar_url_sections[2]) &amp;&amp; $calendar_url_sections[2] &gt;= 1 &amp;&amp; $calendar_url_sections[2] &lt;= 31)
		$date[&#039;day&#039;] = (int)$calendar_url_sections[2];

	}

	$date[&#039;base&#039;] = $base;

	return $date;

}

function bp_group_calendar_event_url_parse() {

	$url = $_SERVER[&#039;REQUEST_URI&#039;];
	if (strpos(&quot;/calendar/event/&quot;, $url) !== false)
	return false;

	$url_clean = explode(&quot;?&quot;, $url);
	$url = $url_clean[0];
	$url_sections = explode(&quot;/calendar/event/&quot;, $url);
	$url = isset($url_sections[1]) ? $url_sections[1] : &#039;&#039;;
	$url = ltrim($url, &quot;/&quot;);
	$url = rtrim($url, &quot;edit/&quot;);
	$url = rtrim($url, &quot;delete/&quot;);
	$url = rtrim($url, &quot;/&quot;);

	if (is_numeric($url))
	return (int)$url;
	else
	return false;

}

function bp_group_calendar_event_is_edit() {

	$url = $_SERVER[&#039;REQUEST_URI&#039;];
	if (strpos($url, &quot;/edit/&quot;))
	return true;
	else
	return false;

}

function bp_group_calendar_event_is_delete() {
	global $wpdb, $current_user, $bp;

	$calendar_capabilities = bp_group_calendar_get_capabilities();
	$event_id = bp_group_calendar_event_url_parse();
	$group_id = $bp-&gt;groups-&gt;current_group-&gt;id;
	$url = $_SERVER[&#039;REQUEST_URI&#039;];
	if (strpos($url, &quot;/delete/&quot;) &amp;&amp; $event_id) {

		//check nonce
		if (!wp_verify_nonce($_REQUEST[&#039;_wpnonce&#039;], &#039;event-delete-link&#039;)) {
			bp_core_add_message( __(&#039;There was a security problem&#039;, &#039;groupcalendar&#039;), &#039;error&#039; );
			return false;
		}

		if ($calendar_capabilities==&#039;none&#039;) {
			bp_core_add_message( __(&#039;You do not have permission to delete events&#039;, &#039;groupcalendar&#039;), &#039;error&#039; );
			return false;
		}

		//can user modify this event?
		if ($calendar_capabilities == &#039;limited&#039;) {
			$creator_id = $wpdb-&gt;get_var(&quot;SELECT user_id FROM &quot; . $wpdb-&gt;base_prefix . &quot;bp_groups_calendars WHERE id = $event_id AND group_id = $group_id&quot;);

			if ($creator_id != $current_user-&gt;ID) {
				bp_core_add_message( __(&quot;You don&#039;t have permission to delete that event&quot;, &#039;groupcalendar&#039;), &#039;error&#039; );
				return false;
			}
		}

		//delete event
		$result = $wpdb-&gt;query(&quot;DELETE FROM &quot; . $wpdb-&gt;base_prefix . &quot;bp_groups_calendars WHERE id = $event_id AND group_id = $group_id LIMIT 1&quot;);

		if (!$result) {
			bp_core_add_message( __(&quot;There was a problem deleting&quot;, &#039;groupcalendar&#039;), &#039;error&#039; );
			return false;
		}

		//delete activity tied to event
		$result = $wpdb-&gt;query(&quot;DELETE FROM &quot; . $wpdb-&gt;base_prefix . &quot;bp_activity WHERE item_id = $group_id AND secondary_item_id = $event_id&quot;);

		//success!
		bp_core_add_message( __(&#039;Event deleted successfully&#039;, &#039;groupcalendar&#039;) );
		return true;

	} else {
		return false;
	}

}


function bp_group_calendar_create_event_url($event_id, $edit=false) {
	global $bp;

	$url = bp_get_group_permalink( $bp-&gt;groups-&gt;current_group );
	$url .= &#039;calendar/event/&#039;.$event_id.&#039;/&#039;;

	if ($edit)
	$url .= &quot;edit/&quot;;

	return $url;

}

//------------------------------------------------------------------------//

//---Output Functions-----------------------------------------------------//

//------------------------------------------------------------------------//


function bp_group_calendar_settings() {
	global $wpdb, $current_site, $groups_template;

	if (!empty($groups_template-&gt;group)) {
		$group = $groups_template-&gt;group;
	}

	if ( !empty($group) ) {
		$group_calendar_moderator_capabilities = groups_get_groupmeta( $group-&gt;id, &#039;group_calendar_moderator_capabilities&#039; );
	}

	if ( empty( $group_calendar_moderator_capabilities ) ){
		$group_calendar_moderator_capabilities = BGC_MODERATOR_DEFAULT;
	}

	if ( !empty($group) ) {
		$group_calendar_member_capabilities = groups_get_groupmeta( $group-&gt;id, &#039;group_calendar_member_capabilities&#039; );
	}

	if ( empty( $group_calendar_member_capabilities ) ){
		$group_calendar_member_capabilities = BGC_MEMBER_DEFAULT;
	}

	$email = groups_get_groupmeta($group-&gt;id, &#039;group_calendar_send_email&#039;);
	if ( empty( $email ) ) {
		$email = BGC_EMAIL_DEFAULT;
	}

	?&gt;
  &lt;h4&gt;&lt;?php _e(&#039;Group Calendar Settings&#039;, &#039;groupcalendar&#039;) ?&gt;&lt;/h4&gt;
	&lt;label for=&quot;group-calendar-moderator-capabilities&quot;&gt;&lt;?php _e(&#039;Moderator Capabilities&#039;, &#039;groupcalendar&#039;) ?&gt;&lt;/label&gt;

          &lt;select name=&quot;group-calendar-moderator-capabilities&quot; id=&quot;group-calendar-moderator-capabilities&quot;&gt;

              &lt;option value=&quot;full&quot; &lt;?php if ( $group_calendar_moderator_capabilities == &#039;full&#039;) { echo &#039;selected=&quot;selected&quot;&#039;; } ?&gt;&gt;&lt;?php _e(&#039;Create events / Edit all events&#039;, &#039;groupcalendar&#039;); ?&gt;&lt;/option&gt;

              &lt;option value=&quot;limited&quot; &lt;?php if ( $group_calendar_moderator_capabilities == &#039;limited&#039;) { echo &#039;selected=&quot;selected&quot;&#039;; } ?&gt;&gt;&lt;?php _e(&#039;Create events / Edit own events&#039;, &#039;groupcalendar&#039;); ?&gt;&lt;/option&gt;

              &lt;option value=&quot;none&quot; &lt;?php if ( $group_calendar_moderator_capabilities == &#039;none&#039;) { echo &#039;selected=&quot;selected&quot;&#039;; } ?&gt;&gt;&lt;?php _e(&#039;No capabilities&#039;, &#039;groupcalendar&#039;); ?&gt;&lt;/option&gt;

          &lt;/select&gt;

	&lt;label for=&quot;group-calendar-member-capabilities&quot;&gt;&lt;?php _e(&#039;Member Capabilities&#039;, &#039;groupcalendar&#039;) ?&gt;&lt;/label&gt;

          &lt;select name=&quot;group-calendar-member-capabilities&quot; id=&quot;group-calendar-member-capabilities&quot;&gt;

              &lt;option value=&quot;full&quot; &lt;?php if ( $group_calendar_member_capabilities == &#039;full&#039;) { echo &#039;selected=&quot;selected&quot;&#039;; } ?&gt;&gt;&lt;?php _e(&#039;Create events / Edit all events&#039;, &#039;groupcalendar&#039;); ?&gt;&lt;/option&gt;

              &lt;option value=&quot;limited&quot; &lt;?php if ( $group_calendar_member_capabilities == &#039;limited&#039;) { echo &#039;selected=&quot;selected&quot;&#039;; } ?&gt;&gt;&lt;?php _e(&#039;Create events / Edit own events&#039;, &#039;groupcalendar&#039;); ?&gt;&lt;/option&gt;

              &lt;option value=&quot;none&quot; &lt;?php if ( $group_calendar_member_capabilities == &#039;none&#039;) { echo &#039;selected=&quot;selected&quot;&#039;; } ?&gt;&gt;&lt;?php _e(&#039;No capabilities&#039;, &#039;groupcalendar&#039;); ?&gt;&lt;/option&gt;

          &lt;/select&gt;

  &lt;label&gt;&lt;?php _e(&#039;Enable Email Notification of New Events&#039;, &#039;groupcalendar&#039;) ?&gt;&lt;br /&gt;
  &lt;small&gt;&lt;?php _e(&#039;Individual users can disable notifications&#039;, &#039;groupcalendar&#039;) ?&gt;&lt;/small&gt;&lt;/label&gt;
    &lt;label&gt;&lt;input value=&quot;yes&quot; name=&quot;group-calendar-send-email&quot; type=&quot;radio&quot;&lt;?php echo ($email == &#039;yes&#039;) ? &#039; checked=&quot;checked&quot;&#039; : &#039;&#039;; ?&gt; /&gt; &lt;?php _e(&#039;Yes&#039;, &#039;groupcalendar&#039;) ?&gt;&lt;/label&gt;
    &lt;label&gt;&lt;input value=&quot;no&quot; name=&quot;group-calendar-send-email&quot; type=&quot;radio&quot;&lt;?php  echo ($email == &#039;no&#039;) ? &#039; checked=&quot;checked&quot;&#039; : &#039;&#039;; ?&gt; /&gt; &lt;?php _e(&#039;No&#039;, &#039;groupcalendar&#039;) ?&gt;&lt;/label&gt;
	&lt;?php
}

function bp_group_calendar_notification_settings() {
	global $current_user;
?&gt;
		&lt;tr&gt;
			&lt;td&gt;&lt;/td&gt;
			&lt;td&gt;&lt;?php _e( &#039;A new group event is created&#039;, &#039;groupcalendar&#039; ) ?&gt;&lt;/td&gt;
			&lt;td class=&quot;yes&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;notifications[notification_groups_calendar_event]&quot; value=&quot;yes&quot; &lt;?php if ( !get_usermeta( $current_user-&gt;id, &#039;notification_groups_calendar_event&#039;) || &#039;yes&#039; == get_usermeta( $current_user-&gt;id, &#039;notification_groups_calendar_event&#039;) ) { ?&gt;checked=&quot;checked&quot; &lt;?php } ?&gt;/&gt;&lt;/td&gt;
			&lt;td class=&quot;no&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;notifications[notification_groups_calendar_event]&quot; value=&quot;no&quot; &lt;?php if ( &#039;no&#039; == get_usermeta( $current_user-&gt;id, &#039;notification_groups_calendar_event&#039;) ) { ?&gt;checked=&quot;checked&quot; &lt;?php } ?&gt;/&gt;&lt;/td&gt;
		&lt;/tr&gt;
&lt;?php
}

function bp_group_calendar_css_output() {
	//display css
	if (strpos($_SERVER[&#039;REQUEST_URI&#039;], &#039;/calendar/&#039;) !== false) {
		global $bgc_locale;
		$css_url = plugins_url(&#039;/bp-group-calendar/groupcalendar/&#039;);
    ?&gt;
    &lt;link type=&quot;text/css&quot; href=&quot;&lt;?php echo $css_url; ?&gt;group_calendar.css&quot; rel=&quot;stylesheet&quot; /&gt;
    &lt;link type=&quot;text/css&quot; href=&quot;&lt;?php echo $css_url; ?&gt;datepicker/css/ui-lightness/jquery-ui-1.7.2.custom.css&quot; rel=&quot;stylesheet&quot; /&gt;	
  	&lt;script type=&quot;text/javascript&quot; src=&quot;&lt;?php echo $css_url; ?&gt;datepicker/js/jquery-ui-1.7.2.custom.min.js&quot;&gt;&lt;/script&gt;
  	&lt;?php if ($bgc_locale[&#039;code&#039;] != &#039;en&#039;) { ?&gt;
    &lt;script type=&quot;text/javascript&quot; src=&quot;&lt;?php echo $css_url; ?&gt;datepicker/js/jquery-ui-i18n.min.js&quot;&gt;&lt;/script&gt;
    &lt;?php } ?&gt;
  	&lt;script type=&quot;text/javascript&quot;&gt;
  	jQuery(document).ready(function ($) {
  		jQuery.datepicker.setDefaults(jQuery.datepicker.regional[&#039;&lt;?php echo $bgc_locale[&#039;code&#039;]; ?&gt;&#039;]);
  		jQuery(&#039;#event-date&#039;).datepicker({dateFormat: &#039;yy-mm-dd&#039;, changeMonth: true, changeYear: true, firstDay: &lt;?php echo $bgc_locale[&#039;week_start&#039;]; ?&gt;});
  		jQuery(&#039;a#event-delete-link&#039;).click(function() {
  			var answer = confirm(&quot;&lt;?php _e(&#039;Are you sure you want to delete this event?&#039;, &#039;groupcalendar&#039;); ?&gt;&quot;)
  			if (answer){
  				return true;
  			} else {
  				return false;
  			};
  		});
  	});
  	&lt;/script&gt;
    &lt;?php
	}
}

function bp_group_calendar_highlighted_events($group_id, $date=&#039;&#039;) {
	global $wpdb;

	if ($date) {
		$start_date = date_i18n(&#039;Y-m-&#039;, strtotime($date)).&#039;01 00:00:00&#039;;
		$end_date = date_i18n(&#039;Y-m-d H:i:s&#039;, strtotime(&quot;-1 second&quot;, strtotime(&quot;+1 month&quot;, strtotime($start_date))));
	} else {
		$start_date = date_i18n(&#039;Y-m-&#039;, time()).&#039;01 00:00:00&#039;;
		$end_date = date_i18n(&#039;Y-m-d H:i:s&#039;, strtotime(&quot;-1 second&quot;, strtotime(&quot;+1 month&quot;, strtotime($start_date))));
	}
	$filter = &quot; WHERE group_id = $group_id AND event_time &gt;= &#039;$start_date&#039; AND event_time &lt;= &#039;$end_date&#039;&quot;;

	$events = $wpdb-&gt;get_col( &quot;SELECT event_time FROM &quot;.$wpdb-&gt;base_prefix.&quot;bp_groups_calendars&quot;.$filter.&quot; ORDER BY event_time ASC&quot; );

	if ($events) {

		$highlighted_events = array();
		foreach ($events as $event) {
			$highlighted_events[] = date_i18n(&#039;Y-m-d&#039;, strtotime($event));
		}

		return $highlighted_events;

	} else {
		return array();
	}

}

function bp_group_calendar_list_events($group_id, $range, $date=&#039;&#039;, $calendar_capabilities, $show_all = 0) {
	global $wpdb, $current_user;

	$date_format = get_option(&#039;date_format&#039;).&#039; &#039;.get_option(&#039;time_format&#039;);

	if ($range == &#039;all&#039;) {

		$filter = &quot; WHERE group_id = $group_id&quot;;
		$empty_message = __(&#039;There are no scheduled events&#039;, &#039;groupcalendar&#039;);

	} else if ($range == &#039;month&#039;) {

		if ($date) {
			$start_date = date_i18n(&#039;Y-m-&#039;, strtotime($date)).&#039;01 00:00:00&#039;;
			$end_date = date_i18n(&#039;Y-m-d H:i:s&#039;, strtotime(&quot;-1 second&quot;, strtotime(&quot;+1 month&quot;, strtotime($start_date))));
		} else {
			$start_date = date_i18n(&#039;Y-m-&#039;, time()).&#039;01 00:00:00&#039;;
			$end_date = date_i18n(&#039;Y-m-d H:i:s&#039;, strtotime(&quot;-1 second&quot;, strtotime(&quot;+1 month&quot;, strtotime($start_date))));
		}
		$filter = &quot; WHERE group_id = $group_id AND event_time &gt;= &#039;$start_date&#039; AND event_time &lt;= &#039;$end_date&#039;&quot;;
		$empty_message = __(&#039;There are no events scheduled for this month&#039;, &#039;groupcalendar&#039;);

	} else if ($range == &#039;day&#039;) {

		$start_date = date_i18n(&#039;Y-m-d H:i:s&#039;, strtotime($date));
		$end_date = date_i18n(&#039;Y-m-d&#039;, strtotime($date)).&#039; 23:59:59&#039;;
		$filter = &quot; WHERE group_id = $group_id AND event_time &gt;= &#039;$start_date&#039; AND event_time &lt;= &#039;$end_date&#039;&quot;;
		$empty_message = __(&#039;There are no events scheduled for this day&#039;, &#039;groupcalendar&#039;);
		$date_format = get_option(&#039;time_format&#039;);

	} else if ($range == &#039;upcoming&#039;) {

		$filter = &quot; WHERE group_id = $group_id AND event_time &gt;= &#039;&quot;.date_i18n(&#039;Y-m-d H:i:s&#039;).&quot;&#039;&quot;;
		$empty_message = __(&#039;There are no upcoming events&#039;, &#039;groupcalendar&#039;);

	} else if ($range == &#039;mine&#039;) {

		$filter = &quot; WHERE group_id = $group_id AND event_time &gt;= &#039;&quot;.date_i18n(&#039;Y-m-d H:i:s&#039;).&quot;&#039; AND user_id = &quot;.$current_user-&gt;ID;
		$empty_message = __(&#039;You have no scheduled events&#039;, &#039;groupcalendar&#039;);

	}

	if (!$show_all)
	$limit = &quot; LIMIT 10&quot;;

	$events = $wpdb-&gt;get_results( &quot;SELECT * FROM &quot;.$wpdb-&gt;base_prefix.&quot;bp_groups_calendars&quot;.$filter.&quot; ORDER BY event_time ASC&quot;.$limit );

	if ($events) {

		$events_list = &#039;&lt;ul class=&quot;events-list&quot;&gt;&#039;;
		//loop through events
		foreach ($events as $event) {
			$class = ($event-&gt;user_id==$current_user-&gt;ID) ? &#039; class=&quot;my_event&quot;&#039; : &#039;&#039;;

			$events_list .= &quot;\n&lt;li&quot;.$class.&quot;&gt;&quot;;
//			eleni changed on 26/1/2011
//$events_list .= &#039;&lt;a href=&quot;&#039;.bp_group_calendar_create_event_url($event-&gt;id).&#039;&quot; title=&quot;&#039;.__(&#039;View Event&#039;, &#039;groupcalendar&#039;).&#039;&quot;&gt;&#039;.stripslashes($event-&gt;event_title).&#039;: &#039;.date_i18n($date_format, strtotime($event-&gt;event_time)).&#039;&lt;/a&gt;&#039;;
			$events_list .= &#039;&lt;a href=&quot;&#039;.bp_group_calendar_create_event_url($event-&gt;id).&#039;&quot; title=&quot;&#039;.__(&#039;View Event&#039;, &#039;groupcalendar&#039;).&#039;&quot; class=&quot;event_title&quot;&gt;&#039;.date_i18n($date_format, strtotime($event-&gt;event_time)).&#039;: &#039;.stripslashes($event-&gt;event_title).&#039;&lt;/a&gt;&#039;;

			//add edit link if allowed
			if ($calendar_capabilities == &#039;full&#039; || ($calendar_capabilities == &#039;limited&#039; &amp;&amp; $event-&gt;user_id==$current_user-&gt;ID)) {
				$events_list .= &#039; | &lt;a href=&quot;&#039;.bp_group_calendar_create_event_url($event-&gt;id, true).&#039;&quot; title=&quot;&#039;.__(&#039;Edit Event&#039;, &#039;groupcalendar&#039;).&#039;&quot;&gt;&#039;.__(&#039;Edit&#039;, &#039;groupcalendar&#039;).&#039; &amp;raquo;&lt;/a&gt;&#039;;
			}

			$events_list .= &quot;&lt;/li&gt;&quot;;
		}
		$events_list .= &quot;&lt;/ul&gt;&quot;;

	} else { //no events for query
		$events_list = &#039;&lt;div id=&quot;message&quot; class=&quot;info&quot;&gt;&lt;p&gt;&#039;.$empty_message.&#039;&lt;/p&gt;&lt;/div&gt;&#039;;
	}

	echo $events_list;
}

//------------------------------------------------------------------------//

//---Page Output Functions------------------------------------------------//

//------------------------------------------------------------------------//

//widgets

function bp_group_calendar_widget_day($date) {
	global $bp, $bgc_locale;

	$calendar_capabilities = bp_group_calendar_get_capabilities();

	$day = $date[&#039;year&#039;].&#039;-&#039;.$date[&#039;month&#039;].&#039;-&#039;.$date[&#039;day&#039;];

	$cal = new Calendar($date[&#039;day&#039;], $date[&#039;year&#039;], $date[&#039;month&#039;]);
	$cal-&gt;week_start = $bgc_locale[&#039;week_start&#039;];
	$url = bp_get_group_permalink( $bp-&gt;groups-&gt;current_group ).&#039;calendar&#039;;
	$cal-&gt;formatted_link_to = $url.&#039;/%Y/%m/%d/&#039;;
  ?&gt;
  &lt;div class=&quot;bp-widget&quot;&gt;
		&lt;h4&gt;&lt;?php _e(&#039;Day View&#039;, &#039;groupcalendar&#039;); ?&gt;: &lt;?php echo date_i18n(get_option(&#039;date_format&#039;), strtotime($day)); ?&gt;&lt;/h4&gt;
		&lt;table class=&quot;calendar-view&quot;&gt;
      &lt;tr&gt;
        &lt;td class=&quot;cal-left&quot;&gt;
          &lt;?php print($cal-&gt;output_calendar()); ?&gt;
        &lt;/td&gt;
        &lt;td class=&quot;cal-right&quot;&gt;
          &lt;h5 class=&quot;events-title&quot;&gt;&lt;?php _e(&quot;Events For&quot;, &#039;groupcalendar&#039;); ?&gt; &lt;?php echo date_i18n(get_option(&#039;date_format&#039;), strtotime($day)); ?&gt;:&lt;/h5&gt;
          &lt;?php bp_group_calendar_list_events($bp-&gt;groups-&gt;current_group-&gt;id, &#039;day&#039;, $day, $calendar_capabilities); ?&gt;
        &lt;/td&gt;
      &lt;/tr&gt; 
    &lt;/table&gt;
  &lt;/div&gt;
  &lt;?php
}

function bp_group_calendar_widget_month($date) {
	global $bp, $bgc_locale;

	$calendar_capabilities = bp_group_calendar_get_capabilities();

	if (isset($date[&#039;month&#039;])) {
		//show selected month
		$cal = new Calendar(&#039;&#039;, $date[&#039;year&#039;], $date[&#039;month&#039;]);
	} else {
		//show current month
		$cal = new Calendar();
	}

	$cal-&gt;week_start = $bgc_locale[&#039;week_start&#039;];
	$url = bp_get_group_permalink( $bp-&gt;groups-&gt;current_group ).&#039;calendar&#039;;
	$cal-&gt;formatted_link_to = $url.&#039;/%Y/%m/%d/&#039;;

	//first day of month for calulation previous and next months
	$first_day = $cal-&gt;year . &quot;-&quot; . $cal-&gt;month . &quot;-01&quot;;
	$cal-&gt;highlighted_dates = bp_group_calendar_highlighted_events($bp-&gt;groups-&gt;current_group-&gt;id, $first_day);
	$previous_month = $url.date(&quot;/Y/m/&quot;, strtotime(&quot;-1 month&quot;, strtotime($first_day)));
	$next_month = $url.date(&quot;/Y/m/&quot;, strtotime(&quot;+1 month&quot;, strtotime($first_day)));
	$this_year = $url.date(&quot;/Y/&quot;, strtotime($first_day));
  ?&gt;
  &lt;div class=&quot;bp-widget&quot;&gt;
		&lt;h4&gt;
    &lt;?php _e(&#039;Month View&#039;, &#039;groupcalendar&#039;); ?&gt;:
    &lt;?php echo date_i18n(__(&#039;F Y&#039;, &#039;groupcalendar&#039;), strtotime($first_day)); ?&gt;
      &lt;span&gt;
        &lt;a title=&quot;&lt;?php _e(&#039;Previous Month&#039;, &#039;groupcalendar&#039;); ?&gt;&quot; href=&quot;&lt;?php echo $previous_month; ?&gt;&quot;&gt;&amp;larr; &lt;?php _e(&#039;Previous&#039;, &#039;groupcalendar&#039;); ?&gt;&lt;/a&gt; | 
        &lt;a title=&quot;&lt;?php _e(&#039;Full Year&#039;, &#039;groupcalendar&#039;); ?&gt;&quot; href=&quot;&lt;?php echo $this_year; ?&gt;&quot;&gt;&lt;?php _e(&#039;Year&#039;, &#039;groupcalendar&#039;); ?&gt;&lt;/a&gt; | 
        &lt;a title=&quot;&lt;?php _e(&#039;Next Month&#039;, &#039;groupcalendar&#039;); ?&gt;&quot; href=&quot;&lt;?php echo $next_month; ?&gt;&quot;&gt;&lt;?php _e(&#039;Next&#039;, &#039;groupcalendar&#039;); ?&gt; &amp;rarr;&lt;/a&gt;
      &lt;/span&gt;
    &lt;/h4&gt;
    &lt;table class=&quot;calendar-view&quot;&gt;
      &lt;tr&gt;
        &lt;td class=&quot;cal-left&quot;&gt;
          &lt;?php print($cal-&gt;output_calendar()); ?&gt;
        &lt;/td&gt;
        &lt;td class=&quot;cal-right&quot;&gt;
		&lt;h5 class=&quot;events-title&quot;&gt;&lt;?php _e(&#039;Events For&#039;, &#039;groupcalendar&#039;); ?&gt; &lt;?php echo date_i18n(&#039;F Y&#039;, strtotime($first_day));?&gt;:&lt;/h5&gt;
    		  &lt;?php bp_group_calendar_list_events($bp-&gt;groups-&gt;current_group-&gt;id, &#039;month&#039;, $first_day, $calendar_capabilities); ?&gt;
        &lt;/td&gt;
      &lt;/tr&gt;   
    &lt;/table&gt;
		
  &lt;/div&gt;
  &lt;?php
}

function bp_group_calendar_widget_year($date) {
	global $bp, $bgc_locale;

	$calendar_capabilities = bp_group_calendar_get_capabilities();

	$year = $date[&#039;year&#039;];
	$month = 1;

	$url = bp_get_group_permalink( $bp-&gt;groups-&gt;current_group ).&#039;calendar&#039;;
	//first day of month for calulation previous and next years
	$first_day = $year . &quot;-01-01&quot;;
	$previous_year = $url.date_i18n(&quot;/Y/&quot;, strtotime(&quot;-1 year&quot;, strtotime($first_day)));
	$next_year = $url.date_i18n(&quot;/Y/&quot;, strtotime(&quot;+1 year&quot;, strtotime($first_day)));

  ?&gt;
  &lt;div class=&quot;bp-widget&quot;&gt;
		&lt;h4&gt;
      &lt;?php _e(&#039;Year View&#039;, &#039;groupcalendar&#039;); ?&gt;: &lt;?php echo date_i18n(&#039;Y&#039;, strtotime($first_day)); ?&gt;
      &lt;span&gt;
        &lt;a title=&quot;&lt;?php _e(&#039;Previous Year&#039;, &#039;groupcalendar&#039;); ?&gt;&quot; href=&quot;&lt;?php echo $previous_year; ?&gt;&quot;&gt;&amp;larr; &lt;?php _e(&#039;Previous&#039;, &#039;groupcalendar&#039;); ?&gt;&lt;/a&gt; | 
        &lt;a title=&quot;&lt;?php _e(&#039;Next Year&#039;, &#039;groupcalendar&#039;); ?&gt;&quot; href=&quot;&lt;?php echo $next_year; ?&gt;&quot;&gt;&lt;?php _e(&#039;Next&#039;, &#039;groupcalendar&#039;); ?&gt; &amp;rarr;&lt;/a&gt;
      &lt;/span&gt;
    &lt;/h4&gt;
    &lt;?php
    //loop through years
    for ($i = 1; $i &lt;= 12; $i++) {
    	$cal = new Calendar(&#039;&#039;, $year, $month);
    	$cal-&gt;week_start = $bgc_locale[&#039;week_start&#039;];
    	$cal-&gt;formatted_link_to = $url.&#039;/%Y/%m/%d/&#039;;
    	$first_day = $cal-&gt;year . &quot;-&quot; . $cal-&gt;month . &quot;-01&quot;;
    	$cal-&gt;highlighted_dates = bp_group_calendar_highlighted_events($bp-&gt;groups-&gt;current_group-&gt;id, $first_day);
    	echo &#039;&lt;div class=&quot;year-cal-item&quot;&gt;&#039;;
    	print($cal-&gt;output_calendar());
    	echo &#039;&lt;/div&gt;&#039;;

    	//first day of month for calulation of next month
    	$first_day = $year . &quot;-&quot; . $month . &quot;-01&quot;;
    	$next_stamp = strtotime(&quot;+1 month&quot;, strtotime($first_day));
    	$year = date_i18n(&quot;Y&quot;, $next_stamp);
    	$month = date_i18n(&quot;m&quot;, $next_stamp);
    }
    ?&gt;
    &lt;div class=&quot;clear&quot;&gt;&lt;/div&gt;
  &lt;/div&gt;
  &lt;?php
}

function bp_group_calendar_widget_upcoming_events() {
	global $bp;

	$calendar_capabilities = bp_group_calendar_get_capabilities();

  ?&gt;
  &lt;div class=&quot;bp-widget&quot;&gt;
		&lt;h4&gt;&lt;?php _e(&#039;Upcoming Events&#039;, &#039;groupcalendar&#039;); ?&gt;&lt;/h4&gt;
	  &lt;?php bp_group_calendar_list_events($bp-&gt;groups-&gt;current_group-&gt;id, &#039;upcoming&#039;, &#039;&#039;, $calendar_capabilities); ?&gt;
  &lt;/div&gt;
  &lt;?php
}

function bp_group_calendar_widget_my_events() {
	global $bp;

	if (!is_user_logged_in())
	return;

	$calendar_capabilities = bp_group_calendar_get_capabilities();

  ?&gt;
  &lt;div class=&quot;bp-widget&quot;&gt;
		&lt;h4&gt;&lt;?php _e(&#039;My Events&#039;, &#039;groupcalendar&#039;); ?&gt;&lt;/h4&gt;
	  &lt;?php bp_group_calendar_list_events($bp-&gt;groups-&gt;current_group-&gt;id, &#039;mine&#039;, &#039;&#039;, $calendar_capabilities); ?&gt;
  &lt;/div&gt;
  &lt;?php
}


function bp_group_calendar_widget_event_display($event_id) {
	global $wpdb, $current_user, $bp, $bgc_locale;

	$group_id = $bp-&gt;groups-&gt;current_group-&gt;id;

	$calendar_capabilities = bp_group_calendar_get_capabilities();

	$event = $wpdb-&gt;get_row(&quot;SELECT * FROM &quot;.$wpdb-&gt;base_prefix.&quot;bp_groups_calendars WHERE group_id = $group_id AND id = $event_id&quot;);

	//do nothing if invalid event_id
	if (!$event)
		return;

	//creat edit link if capable
	if ($calendar_capabilities == &#039;full&#039; || ($calendar_capabilities == &#039;limited&#039; &amp;&amp; $current_user-&gt;ID == $event-&gt;user_id))
		$edit_link = &#039;&lt;span&gt;&lt;a href=&quot;&#039;.bp_group_calendar_create_event_url($event_id, true).&#039;&quot; title=&quot;&#039;.__(&#039;Edit Event&#039;, &#039;groupcalendar&#039;).&#039;&quot;&gt;&#039;.__(&#039;Edit&#039;, &#039;groupcalendar&#039;).&#039; &amp;rarr;&lt;/a&gt;&lt;/span&gt;&#039;;

	$map_url = &#039;http://maps.google.com/maps?hl=&#039;.$bgc_locale[&#039;code&#039;].&#039;&amp;q=&#039;.urlencode(stripslashes($event-&gt;event_location));

	$event_created_by = bp_core_get_userlink($event-&gt;user_id);
	$event_created = date_i18n(get_option(&#039;date_format&#039;).__(&#039; \a\t &#039;, &#039;groupcalendar&#039;).get_option(&#039;time_format&#039;), $event-&gt;created_stamp);
	$event_modified_by = bp_core_get_userlink($event-&gt;last_edited_id);
	$event_last_modified = date_i18n(get_option(&#039;date_format&#039;).__(&#039; \a\t &#039;, &#039;groupcalendar&#039;).get_option(&#039;time_format&#039;), $event-&gt;last_edited_stamp);

	$event_meta = &#039;&lt;span class=&quot;event-meta&quot;&gt;&#039;.sprintf(__(&#039;Created by %1$s on %2$s. Last modified by %3$s on %4$s.&#039;, &#039;groupcalendar&#039;), $event_created_by, $event_created, $event_modified_by, $event_last_modified).&#039;&lt;/span&gt;&#039;;

  ?&gt;
  &lt;div class=&quot;bp-widget&quot;&gt;
		&lt;h4&gt;
      &lt;?php _e(&#039;Event Details&#039;, &#039;groupcalendar&#039;); ?&gt;
      &lt;?php echo $edit_link; ?&gt;
    &lt;/h4&gt;
    
    &lt;h5 class=&quot;events-title&quot;&gt;&lt;?php echo stripslashes($event-&gt;event_title); ?&gt;&lt;/h5&gt;
    &lt;span class=&quot;activity&quot;&gt;&lt;?php echo date_i18n(get_option(&#039;date_format&#039;).__(&#039; \a\t &#039;, &#039;groupcalendar&#039;).get_option(&#039;time_format&#039;), strtotime($event-&gt;event_time)); ?&gt;&lt;/span&gt;
    
    &lt;?php if ($event-&gt;event_description) : ?&gt;
      &lt;h6 class=&quot;event-label&quot;&gt;&lt;?php _e(&#039;Description:&#039;, &#039;groupcalendar&#039;); ?&gt;&lt;/h6&gt;
  	  &lt;div class=&quot;event-description&quot;&gt;
  	    &lt;?php echo stripslashes($event-&gt;event_description); ?&gt;
  	  &lt;/div&gt;
	  &lt;?php endif; ?&gt;
	  
	  &lt;?php if ($event-&gt;event_location) : ?&gt;
	    &lt;h6 class=&quot;event-label&quot;&gt;&lt;?php _e(&#039;Location:&#039;, &#039;groupcalendar&#039;); ?&gt;&lt;/h6&gt;
  	  &lt;div class=&quot;event-location&quot;&gt;
  	  
  	    &lt;?php echo stripslashes($event-&gt;event_location); ?&gt;
  	  
  	  &lt;?php if ($event-&gt;event_map) : ?&gt;
    	  &lt;span class=&quot;event-map&quot;&gt;
    	    &lt;a href=&quot;&lt;?php echo $map_url; ?&gt;&quot; target=&quot;_blank&quot; title=&quot;&lt;?php _e(&#039;View Google Map of Event Location&#039;, &#039;groupcalendar&#039;); ?&gt;&quot;&gt;&lt;?php _e(&#039;Map&#039;, &#039;groupcalendar&#039;); ?&gt; &amp;raquo;&lt;/a&gt;
    	  &lt;/span&gt;
  	  &lt;?php endif; ?&gt;
      &lt;/div&gt;
	  &lt;?php endif; ?&gt;
	  
	  &lt;?php echo $event_meta; ?&gt;
	  
  &lt;/div&gt;
   &lt;?php
}


function bp_group_calendar_widget_create_event($date) {
	global $bp, $bgc_locale;

	$calendar_capabilities = bp_group_calendar_get_capabilities();

	//don&#039;t display widget if no capabilities
	if ($calendar_capabilities == &#039;none&#039;)
		return;

	//if date given and valid, default form to it
	$default_date = &#039;&#039;;
	if ( !empty($date[&#039;year&#039;]) &amp;&amp; !empty($date[&#039;month&#039;]) &amp;&amp; !empty($date[&#039;day&#039;]) ) {
		$timestamp = strtotime($date[&#039;month&#039;].&#039;/&#039;.$date[&#039;day&#039;].&#039;/&#039;.$date[&#039;year&#039;]);
		if ($timestamp &gt;= time())
			$default_date = date(&#039;Y-m-d&#039;, $timestamp);
	}

	$url = bp_get_group_permalink( $bp-&gt;groups-&gt;current_group ).&#039;calendar/&#039;;

  ?&gt;
  &lt;div class=&quot;bp-widget&quot;&gt;
		&lt;h4&gt;&lt;?php _e(&#039;Create Event&#039;, &#039;groupcalendar&#039;); ?&gt;&lt;/h4&gt;
    &lt;form action=&quot;&lt;?php echo $url; ?&gt;&quot; name=&quot;add-event-form&quot; id=&quot;add-event-form&quot; class=&quot;standard-form&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;
			&lt;label for=&quot;event-title&quot;&gt;&lt;?php _e(&#039;Title&#039;, &#039;groupcalendar&#039;); ?&gt; *&lt;/label&gt;
			&lt;input name=&quot;event-title&quot; id=&quot;event-title&quot; value=&quot;&quot; type=&quot;text&quot;&gt;
			
			&lt;label for=&quot;event-date&quot;&gt;&lt;?php _e(&#039;Date&#039;, &#039;groupcalendar&#039;); ?&gt; *
			&lt;input name=&quot;event-date&quot; id=&quot;event-date&quot; value=&quot;&lt;?php echo $default_date; ?&gt;&quot; type=&quot;text&quot;&gt;&lt;/label&gt;
			
			&lt;label for=&quot;event-time&quot;&gt;&lt;?php _e(&#039;Time&#039;, &#039;groupcalendar&#039;); ?&gt; *
			&lt;select name=&quot;event-hour&quot; id=&quot;event-hour&quot;&gt;
		    &lt;?php
		    if ($bgc_locale[&#039;time_format&#039;]==24)
		    $bgc_locale[&#039;time_format&#039;] = 23;
		    for ($i = 1; $i &lt;= $bgc_locale[&#039;time_format&#039;]; $i++) {
		    	$hour_check = ($i == 7) ? &#039; selected=&quot;selected&quot;&#039; : &#039;&#039;;
		    	echo &#039;&lt;option value=&quot;&#039;.$i.&#039;&quot;&#039;.$hour_check.&#039;&gt;&#039;.$i.&quot;&lt;/option&gt;\n&quot;;
		    }
        ?&gt;
			&lt;/select&gt;
      &lt;select name=&quot;event-minute&quot; id=&quot;event-minute&quot;&gt;
		    &lt;option value=&quot;00&quot;&gt;:00&lt;/option&gt;
		    &lt;option value=&quot;15&quot;&gt;:15&lt;/option&gt;
		    &lt;option value=&quot;30&quot;&gt;:30&lt;/option&gt;
		    &lt;option value=&quot;45&quot;&gt;:45&lt;/option&gt;
			&lt;/select&gt;
			&lt;?php if ($bgc_locale[&#039;time_format&#039;]==12) : ?&gt;
			&lt;select name=&quot;event-ampm&quot; id=&quot;event-ampm&quot;&gt;
		    &lt;option value=&quot;am&quot;&gt;am&lt;/option&gt;
		    &lt;option value=&quot;pm&quot;&gt;pm&lt;/option&gt;
			&lt;/select&gt;
			&lt;?php endif; ?&gt;
      &lt;/label&gt;
			
			&lt;label for=&quot;event-desc&quot;&gt;&lt;?php _e(&#039;Description&#039;, &#039;groupcalendar&#039;); ?&gt;&lt;/label&gt;
			&lt;?php
			if (function_exists(&#039;wp_editor&#039;)) {
					wp_editor(&#039;&#039;, &#039;event-desc&#039;, array(&#039;media_buttons&#039; =&gt; false, &#039;dfw&#039; =&gt; false));
			} else {
					the_editor(&#039;&#039;, &#039;event-desc&#039;, &#039;event-desc&#039;, false);
			}
			?&gt;
			
			&lt;label for=&quot;event-loc&quot;&gt;&lt;?php _e(&#039;Location&#039;, &#039;groupcalendar&#039;); ?&gt;&lt;/label&gt;
			&lt;input name=&quot;event-loc&quot; id=&quot;event-loc&quot; value=&quot;&quot; type=&quot;text&quot;&gt;
			
			&lt;label for=&quot;event-map&quot;&gt;&lt;?php _e(&#039;Show Map Link?&#039;, &#039;groupcalendar&#039;); ?&gt;
			&lt;input name=&quot;event-map&quot; id=&quot;event-map&quot; value=&quot;1&quot; type=&quot;checkbox&quot; checked=&quot;checked&quot; /&gt;
      &lt;small&gt;&lt;?php _e(&#039;(Note: Location must be an address)&#039;, &#039;groupcalendar&#039;); ?&gt;&lt;/small&gt;
      &lt;/label&gt;
			
			&lt;input name=&quot;create-event&quot; id=&quot;create-event&quot; value=&quot;1&quot; type=&quot;hidden&quot;&gt;
      &lt;input name=&quot;group-id&quot; id=&quot;group-id&quot; value=&quot;&lt;?php echo $bp-&gt;groups-&gt;current_group-&gt;id; ?&gt;&quot; type=&quot;hidden&quot;&gt;
      &lt;?php wp_nonce_field(&#039;bp_group_calendar&#039;); ?&gt;
      
			&lt;p&gt;&lt;input value=&quot;&lt;?php _e(&#039;Create Event&#039;, &#039;groupcalendar&#039;); ?&gt; &amp;raquo;&quot; id=&quot;save&quot; name=&quot;save&quot; type=&quot;submit&quot;&gt;&lt;/p&gt;
			
	 &lt;/form&gt;
		
  &lt;/div&gt;
  &lt;?php
}


function bp_group_calendar_widget_edit_event($event_id=false) {
	global $wpdb, $current_user, $bp, $bgc_locale;

	$url = bp_get_group_permalink( $bp-&gt;groups-&gt;current_group ).&#039;calendar/&#039;;

	$group_id = $bp-&gt;groups-&gt;current_group-&gt;id;

	$calendar_capabilities = bp_group_calendar_get_capabilities();

	//don&#039;t display widget if no capabilities
	if ($calendar_capabilities == &#039;none&#039;) {
		bp_core_add_message( __(&quot;You don&#039;t have permission to edit events&quot;, &#039;groupcalendar&#039;), &#039;error&#039; );
		return false;
	}

	if ($event_id) { //load from DB

		$url .= &#039;event/&#039;.$event_id.&#039;/&#039;;

		$event = $wpdb-&gt;get_row(&quot;SELECT * FROM &quot;.$wpdb-&gt;base_prefix.&quot;bp_groups_calendars WHERE group_id = $group_id AND id = $event_id&quot;);

		if (!$event)
		return false;

		//check limited capability users
		if ($calendar_capabilities == &#039;limited&#039; &amp;&amp; $current_user-&gt;ID != $event-&gt;user_id) {
			bp_core_add_message( __(&quot;You don&#039;t have permission to edit that event&quot;, &#039;groupcalendar&#039;), &#039;error&#039; );
			return false;
		}

		$event_title = stripslashes($event-&gt;event_title);

		//check for valid date/time
		$tmp_date = strtotime($event-&gt;event_time);
		if ($tmp_date) {
			$event_date = date_i18n(&#039;Y-m-d&#039;, $tmp_date);

			$event_hour = date_i18n(&#039;g&#039;, $tmp_date);
			$event_minute = date_i18n(&#039;i&#039;, $tmp_date);
			$event_ampm = date_i18n(&#039;a&#039;, $tmp_date);
		} else {
			$event_hour = 7;
		}

		$event_description = stripslashes($event-&gt;event_description);
		$event_location = stripslashes($event-&gt;event_location);
		$event_map = ($event-&gt;event_map == 1) ? &#039; checked=&quot;checked&quot;&#039; : &#039;&#039;;

		$event_created_by = bp_core_get_userlink($event-&gt;user_id);
		$event_created = date_i18n(get_option(&#039;date_format&#039;).__(&#039; \a\t &#039;, &#039;groupcalendar&#039;).get_option(&#039;time_format&#039;), $event-&gt;created_stamp);
		$event_modified_by = bp_core_get_userlink($event-&gt;last_edited_id);
		$event_last_modified = date_i18n(get_option(&#039;date_format&#039;).__(&#039; \a\t &#039;, &#039;groupcalendar&#039;).get_option(&#039;time_format&#039;), $event-&gt;last_edited_stamp);

		$event_meta = &#039;&lt;span class=&quot;event-meta&quot;&gt;&#039;.sprintf(__(&#039;Created by %1$s on %2$s. Last modified by %3$s on %4$s.&#039;, &#039;groupcalendar&#039;), $event_created_by, $event_created, $event_modified_by, $event_last_modified).&#039;&lt;/span&gt;&#039;;

		$delete_url = $url.&#039;delete/&#039;;
		$delete_url = wp_nonce_url($delete_url, &#039;event-delete-link&#039;);
		$delete_link = &#039;&lt;span&gt;&lt;a id=&quot;event-delete-link&quot; href=&quot;&#039;.$delete_url.&#039;&quot; title=&quot;&#039;.__(&#039;Delete Event&#039;, &#039;groupcalendar&#039;).&#039;&quot;&gt;&#039;.__(&#039;Delete&#039;, &#039;groupcalendar&#039;).&#039; &amp;rarr;&lt;/a&gt;&lt;/span&gt;&#039;;

	} else { //load POST variables

		if (!isset($_POST[&#039;create-event&#039;]))
		return false;

		$event_title = esc_attr(strip_tags(trim(stripslashes($_POST[&#039;event-title&#039;]))));
		$tmp_date = $_POST[&#039;event-date&#039;].&#039; &#039;.$_POST[&#039;event-hour&#039;].&#039;:&#039;.$_POST[&#039;event-minute&#039;].$_POST[&#039;event-ampm&#039;];
		$tmp_date = strtotime($tmp_date);

		//check for valid date/time
		if ($tmp_date &amp;&amp; $tmp_date &gt;= time()) {
			$event_date = date_i18n(&#039;Y-m-d&#039;, $tmp_date);

			if ($bgc_locale[&#039;time_format&#039;]==12)
			$event_hour = date_i18n(&#039;g&#039;, $tmp_date);
			else
			$event_hour = date_i18n(&#039;G&#039;, $tmp_date);

			$event_minute = date_i18n(&#039;i&#039;, $tmp_date);
			$event_ampm = date_i18n(&#039;a&#039;, $tmp_date);
		} else {
			$event_hour = 7;
		}

		$event_description = stripslashes(wp_filter_post_kses($_POST[&#039;event-desc&#039;]));
		$event_location = esc_attr(strip_tags(trim(stripslashes($_POST[&#039;event-loc&#039;]))));
		$event_map = ($_POST[&#039;event-map&#039;]==1) ? &#039; checked=&quot;checked&quot;&#039; : &#039;&#039;;

	}

  ?&gt;
  &lt;div class=&quot;bp-widget&quot;&gt;
		&lt;h4&gt;
      &lt;?php _e(&#039;Edit Event&#039;, &#039;groupcalendar&#039;); ?&gt;
      &lt;?php echo $delete_link; ?&gt;
    &lt;/h4&gt;
    
    &lt;form action=&quot;&lt;?php echo $url; ?&gt;&quot; name=&quot;add-event-form&quot; id=&quot;add-event-form&quot; class=&quot;standard-form&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;
			&lt;label for=&quot;event-title&quot;&gt;&lt;?php _e(&#039;Title&#039;, &#039;groupcalendar&#039;); ?&gt; *&lt;/label&gt;
			&lt;input name=&quot;event-title&quot; id=&quot;event-title&quot; value=&quot;&lt;?php echo $event_title; ?&gt;&quot; type=&quot;text&quot;&gt;
			
			&lt;label for=&quot;event-date&quot;&gt;&lt;?php _e(&#039;Date&#039;, &#039;groupcalendar&#039;); ?&gt; *
			&lt;input name=&quot;event-date&quot; id=&quot;event-date&quot; value=&quot;&lt;?php echo $event_date; ?&gt;&quot; type=&quot;text&quot;&gt;&lt;/label&gt;
			
			&lt;label for=&quot;event-time&quot;&gt;&lt;?php _e(&#039;Time&#039;, &#039;groupcalendar&#039;); ?&gt; *
			&lt;select name=&quot;event-hour&quot; id=&quot;event-hour&quot;&gt;
			  &lt;?php
			  if ($bgc_locale[&#039;time_format&#039;]==24)
			  $bgc_locale[&#039;time_format&#039;] = 23;
			  for ($i = 1; $i &lt;= $bgc_locale[&#039;time_format&#039;]; $i++) {
			  	$hour_check = ($i == $event_hour) ? &#039; selected=&quot;selected&quot;&#039; : &#039;&#039;;
			  	echo &#039;&lt;option value=&quot;&#039;.$i.&#039;&quot;&#039;.$hour_check.&#039;&gt;&#039;.$i.&quot;&lt;/option&gt;\n&quot;;
			  }
        ?&gt;
			&lt;/select&gt;
      &lt;select name=&quot;event-minute&quot; id=&quot;event-minute&quot;&gt;
		    &lt;option value=&quot;00&quot;&lt;?php echo ($event_minute==&#039;00&#039;) ? &#039; selected=&quot;selected&quot;&#039; : &#039;&#039;; ?&gt;&gt;:00&lt;/option&gt;
		    &lt;option value=&quot;15&quot;&lt;?php echo ($event_minute==&#039;15&#039;) ? &#039; selected=&quot;selected&quot;&#039; : &#039;&#039;; ?&gt;&gt;:15&lt;/option&gt;
		    &lt;option value=&quot;30&quot;&lt;?php echo ($event_minute==&#039;30&#039;) ? &#039; selected=&quot;selected&quot;&#039; : &#039;&#039;; ?&gt;&gt;:30&lt;/option&gt;
		    &lt;option value=&quot;45&quot;&lt;?php echo ($event_minute==&#039;45&#039;) ? &#039; selected=&quot;selected&quot;&#039; : &#039;&#039;; ?&gt;&gt;:45&lt;/option&gt;
			&lt;/select&gt;
			&lt;?php if ($bgc_locale[&#039;time_format&#039;]==12) : ?&gt;
			&lt;select name=&quot;event-ampm&quot; id=&quot;event-ampm&quot;&gt;
		    &lt;option value=&quot;am&quot;&lt;?php echo ($event_ampm==&#039;am&#039;) ? &#039; selected=&quot;selected&quot;&#039; : &#039;&#039;; ?&gt;&gt;am&lt;/option&gt;
		    &lt;option value=&quot;pm&quot;&lt;?php echo ($event_ampm==&#039;pm&#039;) ? &#039; selected=&quot;selected&quot;&#039; : &#039;&#039;; ?&gt;&gt;pm&lt;/option&gt;
			&lt;/select&gt;
			&lt;?php endif; ?&gt;
      &lt;/label&gt;
			
			&lt;label for=&quot;event-desc&quot;&gt;&lt;?php _e(&#039;Description&#039;, &#039;groupcalendar&#039;); ?&gt;&lt;/label&gt;
			&lt;?php if (function_exists(&#039;wp_editor&#039;)) {
        wp_editor($event_description, &#039;event-desc&#039;, array(&#039;media_buttons&#039; =&gt; false, &#039;dfw&#039; =&gt; false));
			} else {
				the_editor($event_description, &#039;event-desc&#039;, &#039;event-desc&#039;, false);
			}
			?&gt;
			
			&lt;label for=&quot;event-loc&quot;&gt;&lt;?php _e(&#039;Location&#039;, &#039;groupcalendar&#039;); ?&gt;&lt;/label&gt;
			&lt;input name=&quot;event-loc&quot; id=&quot;event-loc&quot; value=&quot;&lt;?php echo $event_location; ?&gt;&quot; type=&quot;text&quot;&gt;
			
			&lt;label for=&quot;event-map&quot;&gt;&lt;?php _e(&#039;Show Map Link?&#039;, &#039;groupcalendar&#039;); ?&gt;
			&lt;input name=&quot;event-map&quot; id=&quot;event-map&quot; value=&quot;1&quot; type=&quot;checkbox&quot;&lt;?php echo $event_map; ?&gt; /&gt;
      &lt;small&gt;&lt;?php _e(&#039;(Note: Location must be an address)&#039;, &#039;groupcalendar&#039;); ?&gt;&lt;/small&gt;
      &lt;/label&gt;
			
			&lt;?php if ($event_id) : ?&gt;
			&lt;input name=&quot;event-id&quot; id=&quot;event-id&quot; value=&quot;&lt;?php echo $event_id; ?&gt;&quot; type=&quot;hidden&quot;&gt;
			&lt;?php endif; ?&gt;
			
      &lt;input name=&quot;create-event&quot; id=&quot;create-event&quot; value=&quot;1&quot; type=&quot;hidden&quot;&gt;
      &lt;input name=&quot;group-id&quot; id=&quot;group-id&quot; value=&quot;&lt;?php echo $bp-&gt;groups-&gt;current_group-&gt;id; ?&gt;&quot; type=&quot;hidden&quot;&gt;
      &lt;?php wp_nonce_field(&#039;bp_group_calendar&#039;); ?&gt;
      
      &lt;?php echo $event_meta; ?&gt;
      
			&lt;p&gt;&lt;input value=&quot;&lt;?php _e(&#039;Save Event&#039;, &#039;groupcalendar&#039;); ?&gt; &amp;raquo;&quot; id=&quot;save&quot; name=&quot;save&quot; type=&quot;submit&quot;&gt;&lt;/p&gt;
			
	 &lt;/form&gt;
		
  &lt;/div&gt;
  &lt;?php

  //return true if all is well
  return true;
}


class BP_Group_Calendar_Widget extends WP_Widget {

	function BP_Group_Calendar_Widget() {
		$widget_ops = array(&#039;classname&#039; =&gt; &#039;bp_group_calendar&#039;, &#039;description&#039; =&gt; __(&#039;Displays upcoming public group events.&#039;, &#039;groupcalendar&#039;) );
		$this-&gt;WP_Widget(&#039;bp_group_calendar&#039;, __(&#039;Group Events&#039;, &#039;groupcalendar&#039;), $widget_ops);
	}

	function widget($args, $instance) {
		global $wpdb, $current_user, $bp;

		extract( $args );

		$date_format = get_option(&#039;date_format&#039;).&#039; &#039;.get_option(&#039;time_format&#039;);

		echo $before_widget;
		$title = $instance[&#039;title&#039;];
		if ( !empty( $title ) ) { echo $before_title . apply_filters(&#039;widget_title&#039;, $title) . $after_title; };

		$events = $wpdb-&gt;get_results( &quot;SELECT gc.id, gc.user_id, gc.event_title, gc.event_time, gp.name, gc.group_id FROM &quot;.$wpdb-&gt;base_prefix.&quot;bp_groups_calendars gc JOIN &quot;.$wpdb-&gt;base_prefix.&quot;bp_groups gp ON gc.group_id=gp.id WHERE gc.event_time &gt;= &#039;&quot;.date(&#039;Y-m-d H:i:s&#039;).&quot;&#039; AND gp.status = &#039;public&#039; ORDER BY gc.event_time ASC LIMIT &quot;.(int)$instance[&#039;num_events&#039;] );

		if ($events) {

			echo &#039;&lt;ul class=&quot;events-list&quot;&gt;&#039;;
			//loop through events
			$events_list = &#039;&#039;;
			foreach ($events as $event) {
				$class = ($event-&gt;user_id==$current_user-&gt;ID) ? &#039; class=&quot;my_event&quot;&#039; : &#039;&#039;;
				$events_list .= &quot;\n&lt;li&quot;.$class.&quot;&gt;&quot;;
				$group = groups_get_group( array( &#039;group_id&#039; =&gt; $event-&gt;group_id ) );
				$url =  bp_get_group_permalink($group).&#039;calendar/event/&#039;.$event-&gt;id.&#039;/&#039;;
				$events_list .= stripslashes($event-&gt;name).&#039;&lt;br /&gt;&lt;a href=&quot;&#039;.$url.&#039;&quot; title=&quot;&#039;.__(&#039;View Event&#039;, &#039;groupcalendar&#039;).&#039;&quot;&gt;&#039;.date_i18n($date_format, strtotime($event-&gt;event_time)).&#039;: &#039;.stripslashes($event-&gt;event_title).&#039;&lt;/a&gt;&#039;;
				$events_list .= &quot;&lt;/li&gt;&quot;;
			}
			echo $events_list;
			echo &quot;\n&lt;/ul&gt;&quot;;

  } else { ?&gt;
		&lt;div class=&quot;widget-error&quot;&gt;
			&lt;?php _e(&#039;There are no upcoming group events.&#039;, &#039;groupcalendar&#039;) ?&gt;
		&lt;/div&gt;
	&lt;?php } ?&gt;
	
	&lt;?php echo $after_widget; ?&gt;
	&lt;?php
	}

	function update( $new_instance, $old_instance ) {
		$instance = $old_instance;
		$instance[&#039;title&#039;] = strip_tags( $new_instance[&#039;title&#039;] );
		$instance[&#039;num_events&#039;] = strip_tags( $new_instance[&#039;num_events&#039;] );

		return $instance;
	}

	function form( $instance ) {
		$instance = wp_parse_args( (array) $instance, array( &#039;title&#039; =&gt; __(&#039;Upcoming Group Events&#039;, &#039;groupcalendar&#039;), &#039;num_events&#039; =&gt; 10 ) );
		$title = strip_tags($instance[&#039;title&#039;]);
		$num_events = strip_tags($instance[&#039;num_events&#039;]);
  ?&gt;
			&lt;p&gt;&lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id(&#039;title&#039;); ?&gt;&quot;&gt;&lt;?php _e(&#039;Title:&#039;, &#039;groupcalendar&#039;) ?&gt; &lt;input class=&quot;widefat&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id(&#039;title&#039;); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name(&#039;title&#039;); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php echo esc_attr($title); ?&gt;&quot; /&gt;&lt;/label&gt;&lt;/p&gt;
			&lt;p&gt;&lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id(&#039;num_events&#039;); ?&gt;&quot;&gt;&lt;?php _e(&#039;Number of Events:&#039;, &#039;groupcalendar&#039;) ?&gt; &lt;input class=&quot;widefat&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id(&#039;num_events&#039;); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name(&#039;num_events&#039;); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php echo esc_attr($num_events); ?&gt;&quot; style=&quot;width: 30%&quot; /&gt;&lt;/label&gt;&lt;/p&gt;
	&lt;?php
	}
}

class BP_Group_Calendar_Widget_Single extends WP_Widget {

	function BP_Group_Calendar_Widget_Single() {
		$widget_ops = array(&#039;classname&#039; =&gt; &#039;bp_group_calendar_single&#039;, &#039;description&#039; =&gt; __(&#039;Displays upcoming group events for a single group.&#039;, &#039;groupcalendar&#039;) );
		$this-&gt;WP_Widget(&#039;bp_group_calendar_single&#039;, __(&#039;Single Group Events&#039;, &#039;groupcalendar&#039;), $widget_ops);
	}

	function widget($args, $instance) {
		global $wpdb, $current_user, $bp;

		extract( $args );

		$date_format = get_option(&#039;date_format&#039;).&#039; &#039;.get_option(&#039;time_format&#039;);

		echo $before_widget;
		$title = $instance[&#039;title&#039;];
		if ( !empty( $title ) ) { echo $before_title . apply_filters(&#039;widget_title&#039;, $title) . $after_title; };

		$events = $wpdb-&gt;get_results( &quot;SELECT gc.id, gc.user_id, gc.event_title, gc.event_time, gp.name, gc.group_id FROM &quot;.$wpdb-&gt;base_prefix.&quot;bp_groups_calendars gc JOIN &quot;.$wpdb-&gt;base_prefix.&quot;bp_groups gp ON gc.group_id=gp.id WHERE gc.event_time &gt;= &#039;&quot;.date(&#039;Y-m-d H:i:s&#039;).&quot;&#039; AND gp.id = &quot;.(int)$instance[&#039;group_id&#039;].&quot; ORDER BY gc.event_time ASC LIMIT &quot;.(int)$instance[&#039;num_events&#039;] );

		if ($events) {

			echo &#039;&lt;ul class=&quot;events-list&quot;&gt;&#039;;
			//loop through events
			$events_list = &#039;&#039;;
			foreach ($events as $event) {
				$class = ($event-&gt;user_id==$current_user-&gt;ID) ? &#039; class=&quot;my_event&quot;&#039; : &#039;&#039;;
				$events_list .= &quot;\n&lt;li&quot;.$class.&quot;&gt;&quot;;
				$group = groups_get_group( array( &#039;group_id&#039; =&gt; $event-&gt;group_id ) );
				$url =  bp_get_group_permalink($group).&#039;calendar/event/&#039;.$event-&gt;id.&#039;/&#039;;
				$events_list .= stripslashes($event-&gt;name).&#039;&lt;br /&gt;&lt;a href=&quot;&#039;.$url.&#039;&quot; title=&quot;&#039;.__(&#039;View Event&#039;, &#039;groupcalendar&#039;).&#039;&quot;&gt;&#039;.date_i18n($date_format, strtotime($event-&gt;event_time)).&#039;: &#039;.stripslashes($event-&gt;event_title).&#039;&lt;/a&gt;&#039;;
				$events_list .= &quot;&lt;/li&gt;&quot;;
			}
			echo $events_list;
			echo &quot;\n&lt;/ul&gt;&quot;;

  } else { ?&gt;
		&lt;div class=&quot;widget-error&quot;&gt;
			&lt;?php _e(&#039;There are no upcoming events for this group.&#039;, &#039;groupcalendar&#039;) ?&gt;
		&lt;/div&gt;
	&lt;?php } ?&gt;

	&lt;?php echo $after_widget; ?&gt;
	&lt;?php
	}

	function update( $new_instance, $old_instance ) {
		$instance = $old_instance;
		$instance[&#039;title&#039;] = strip_tags( $new_instance[&#039;title&#039;] );
		$instance[&#039;num_events&#039;] = strip_tags( $new_instance[&#039;num_events&#039;] );
		$instance[&#039;group_id&#039;] = (int)$new_instance[&#039;group_id&#039;];

		return $instance;
	}

	function form( $instance ) {
		global $wpdb;
		$instance = wp_parse_args( (array) $instance, array( &#039;title&#039; =&gt; __(&#039;Upcoming Group Events&#039;, &#039;groupcalendar&#039;), &#039;num_events&#039; =&gt; 10 ) );
		$title = strip_tags($instance[&#039;title&#039;]);
		$num_events = strip_tags($instance[&#039;num_events&#039;]);
		$group_id = $instance[&#039;group_id&#039;];
  ?&gt;
	&lt;p&gt;&lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id(&#039;title&#039;); ?&gt;&quot;&gt;&lt;?php _e(&#039;Title:&#039;, &#039;groupcalendar&#039;) ?&gt; &lt;input class=&quot;widefat&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id(&#039;title&#039;); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name(&#039;title&#039;); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php echo esc_attr($title); ?&gt;&quot; /&gt;&lt;/label&gt;&lt;/p&gt;
	&lt;p&gt;&lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id(&#039;num_events&#039;); ?&gt;&quot;&gt;&lt;?php _e(&#039;Number of Events:&#039;, &#039;groupcalendar&#039;) ?&gt; &lt;input class=&quot;widefat&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id(&#039;num_events&#039;); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name(&#039;num_events&#039;); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php echo esc_attr($num_events); ?&gt;&quot; style=&quot;width: 30%&quot; /&gt;&lt;/label&gt;&lt;/p&gt;

&lt;?php
$groups = $wpdb-&gt;get_results( &quot;SELECT id, name FROM {$wpdb-&gt;base_prefix}bp_groups ORDER BY name LIMIT 999&quot;); //we don&#039;t want thousands of groups in the dropdown.
if ($groups) {
	echo &#039;&lt;p&gt;&lt;label for=&quot;&#039;.$this-&gt;get_field_id(&#039;group_id&#039;).&#039;&quot;&gt;&#039;.__(&#039;Group:&#039;, &#039;groupcalendar&#039;).&#039; &lt;select class=&quot;widefat&quot; id=&quot;&#039;.$this-&gt;get_field_id(&#039;group_id&#039;).&#039;&quot; name=&quot;&#039;.$this-&gt;get_field_name(&#039;group_id&#039;).&#039;&quot;&gt;&#039;;

	foreach ($groups as $group)
	echo &#039;&lt;option value=&quot;&#039;.$group-&gt;id.&#039;&quot;&#039;.(($group_id == $group-&gt;id) ? &#039; selected=&quot;selected&quot;&#039; : &#039;&#039;).&#039;&gt;&#039;.esc_attr($group-&gt;name).&#039;&lt;/option&gt;&#039;;

	echo &#039;&lt;/select&gt;&lt;/label&gt;&lt;/p&gt;&#039;;
}
	}
}

class BP_Group_Calendar_Widget_User_Groups extends WP_Widget {

	function BP_Group_Calendar_Widget_User_Groups() {
		$widget_ops = array(&#039;classname&#039; =&gt; &#039;bp_group_calendar_user_groups&#039;, &#039;description&#039; =&gt; __(&#039;Displays upcoming group events for a logged in user\&#039;s groups.&#039;, &#039;groupcalendar&#039;) );
		$this-&gt;WP_Widget(&#039;bp_group_calendar_user_groups&#039;, __(&#039;User\&#039;s Group Events&#039;, &#039;groupcalendar&#039;), $widget_ops);
	}

	function widget($args, $instance) {
		global $wpdb, $current_user, $bp;

		//only show widget to logged in users
		if (!is_user_logged_in())
		return;

		//get the groups the user is part of
		$results = groups_get_user_groups($current_user-&gt;ID);

		//don&#039;t show widget if user doesn&#039;t have any groups
		if ($results[&#039;total&#039;] == 0)
		return;

		extract( $args );

		$date_format = get_option(&#039;date_format&#039;).&#039; &#039;.get_option(&#039;time_format&#039;);

		echo $before_widget;
		$title = $instance[&#039;title&#039;];
		if ( !empty( $title ) ) { echo $before_title . apply_filters(&#039;widget_title&#039;, $title) . $after_title; };

		$group_ids = implode(&#039;,&#039;,$results[&#039;groups&#039;]);

		$events = $wpdb-&gt;get_results( &quot;SELECT gc.id, gc.user_id, gc.event_title, gc.event_time, gp.name, gc.group_id FROM &quot;.$wpdb-&gt;base_prefix.&quot;bp_groups_calendars gc JOIN &quot;.$wpdb-&gt;base_prefix.&quot;bp_groups gp ON gc.group_id=gp.id WHERE gc.event_time &gt;= &#039;&quot;.date(&#039;Y-m-d H:i:s&#039;).&quot;&#039; AND gp.id IN ($group_ids) ORDER BY gc.event_time ASC LIMIT &quot;.(int)$instance[&#039;num_events&#039;] );

		if ($events) {

			echo &#039;&lt;ul class=&quot;events-list&quot;&gt;&#039;;
			//loop through events
			$events_list = &#039;&#039;;
			foreach ($events as $event) {
				$class = ($event-&gt;user_id==$current_user-&gt;ID) ? &#039; class=&quot;my_event&quot;&#039; : &#039;&#039;;
				$events_list .= &quot;\n&lt;li&quot;.$class.&quot;&gt;&quot;;
				$group = groups_get_group( array( &#039;group_id&#039; =&gt; $event-&gt;group_id ) );
				$url =  bp_get_group_permalink($group).&#039;calendar/event/&#039;.$event-&gt;id.&#039;/&#039;;
				$events_list .= stripslashes($event-&gt;name).&#039;&lt;br /&gt;&lt;a href=&quot;&#039;.$url.&#039;&quot; title=&quot;&#039;.__(&#039;View Event&#039;, &#039;groupcalendar&#039;).&#039;&quot;&gt;&#039;.date_i18n($date_format, strtotime($event-&gt;event_time)).&#039;: &#039;.stripslashes($event-&gt;event_title).&#039;&lt;/a&gt;&#039;;
				$events_list .= &quot;&lt;/li&gt;&quot;;
			}
			echo $events_list;
			echo &quot;\n&lt;/ul&gt;&quot;;

  } else { ?&gt;
		&lt;div class=&quot;widget-error&quot;&gt;
			&lt;?php _e(&#039;There are no upcoming events for your groups.&#039;, &#039;groupcalendar&#039;) ?&gt;
		&lt;/div&gt;
	&lt;?php } ?&gt;

	&lt;?php echo $after_widget; ?&gt;
	&lt;?php
	}

	function update( $new_instance, $old_instance ) {
		$instance = $old_instance;
		$instance[&#039;title&#039;] = strip_tags( $new_instance[&#039;title&#039;] );
		$instance[&#039;num_events&#039;] = strip_tags( $new_instance[&#039;num_events&#039;] );

		return $instance;
	}

	function form( $instance ) {
		$instance = wp_parse_args( (array) $instance, array( &#039;title&#039; =&gt; __(&#039;Your Upcoming Group Events&#039;, &#039;groupcalendar&#039;), &#039;num_events&#039; =&gt; 10 ) );
		$title = strip_tags($instance[&#039;title&#039;]);
		$num_events = strip_tags($instance[&#039;num_events&#039;]);
  ?&gt;
			&lt;p&gt;&lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id(&#039;title&#039;); ?&gt;&quot;&gt;&lt;?php _e(&#039;Title:&#039;, &#039;groupcalendar&#039;) ?&gt; &lt;input class=&quot;widefat&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id(&#039;title&#039;); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name(&#039;title&#039;); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php echo esc_attr($title); ?&gt;&quot; /&gt;&lt;/label&gt;&lt;/p&gt;
			&lt;p&gt;&lt;label for=&quot;&lt;?php echo $this-&gt;get_field_id(&#039;num_events&#039;); ?&gt;&quot;&gt;&lt;?php _e(&#039;Number of Events:&#039;, &#039;groupcalendar&#039;) ?&gt; &lt;input class=&quot;widefat&quot; id=&quot;&lt;?php echo $this-&gt;get_field_id(&#039;num_events&#039;); ?&gt;&quot; name=&quot;&lt;?php echo $this-&gt;get_field_name(&#039;num_events&#039;); ?&gt;&quot; type=&quot;text&quot; value=&quot;&lt;?php echo esc_attr($num_events); ?&gt;&quot; style=&quot;width: 30%&quot; /&gt;&lt;/label&gt;&lt;/p&gt;
	&lt;?php
	}
}

//------------------------------------------------------------------------//

//---Support Functions----------------------------------------------------//

//------------------------------------------------------------------------//



?&gt;</textarea>
		<input type="hidden" name="action" value="update" />
		<input type="hidden" name="file" value="bp-group-calendar/groupcalendar/bp-group-calendar.php" />
		<input type="hidden" name="plugin" value="bp-group-calendar/groupcalendar/bp-group-calendar.php" />
		<input type="hidden" name="scrollto" id="scrollto" value="0" />
		</div>
				<div id="documentation" class="hide-if-no-js"><label for="docs-list">Documentation:</label> <select name="docs-list" id="docs-list"><option value="">Function Name&hellip;</option><option value="Calendar">Calendar()</option><option value="__">__()</option><option value="_e">_e()</option><option value="add_action">add_action()</option><option value="add_site_option">add_site_option()</option><option value="apply_filters">apply_filters()</option><option value="bp_activity_set_action">bp_activity_set_action()</option><option value="bp_core_add_message">bp_core_add_message()</option><option value="bp_core_get_user_domain">bp_core_get_user_domain()</option><option value="bp_core_get_userlink">bp_core_get_userlink()</option><option value="bp_get_group_permalink">bp_get_group_permalink()</option><option value="bp_group_is_admin">bp_group_is_admin()</option><option value="bp_group_is_member">bp_group_is_member()</option><option value="bp_group_is_mod">bp_group_is_mod()</option><option value="bp_register_group_extension">bp_register_group_extension()</option><option value="create_function">create_function()</option><option value="date">date()</option><option value="date_i18n">date_i18n()</option><option value="do_action">do_action()</option><option value="esc_attr">esc_attr()</option><option value="explode">explode()</option><option value="extract">extract()</option><option value="function_exists">function_exists()</option><option value="get_blog_option">get_blog_option()</option><option value="get_current_user_id">get_current_user_id()</option><option value="get_group_member_ids">get_group_member_ids()</option><option value="get_option">get_option()</option><option value="get_site_option">get_site_option()</option><option value="get_userdata">get_userdata()</option><option value="get_usermeta">get_usermeta()</option><option value="groups_get_group">groups_get_group()</option><option value="groups_get_groupmeta">groups_get_groupmeta()</option><option value="groups_get_user_groups">groups_get_user_groups()</option><option value="groups_record_activity">groups_record_activity()</option><option value="groups_update_groupmeta">groups_update_groupmeta()</option><option value="groups_update_last_activity">groups_update_last_activity()</option><option value="implode">implode()</option><option value="is_numeric">is_numeric()</option><option value="is_user_logged_in">is_user_logged_in()</option><option value="ltrim">ltrim()</option><option value="plugins_url">plugins_url()</option><option value="rtrim">rtrim()</option><option value="sprintf">sprintf()</option><option value="strip_tags">strip_tags()</option><option value="stripslashes">stripslashes()</option><option value="strpos">strpos()</option><option value="strtotime">strtotime()</option><option value="the_editor">the_editor()</option><option value="time">time()</option><option value="trailingslashit">trailingslashit()</option><option value="trim">trim()</option><option value="update_site_option">update_site_option()</option><option value="urlencode">urlencode()</option><option value="wp_editor">wp_editor()</option><option value="wp_filter_post_kses">wp_filter_post_kses()</option><option value="wp_mail">wp_mail()</option><option value="wp_nonce_field">wp_nonce_field()</option><option value="wp_nonce_url">wp_nonce_url()</option><option value="wp_parse_args">wp_parse_args()</option><option value="wp_verify_nonce">wp_verify_nonce()</option><option value="wpautop">wpautop()</option></select> <input type="button" class="button" value="Lookup " onclick="if ( '' != jQuery('#docs-list').val() ) { window.open( 'http://api.wordpress.org/core/handbook/1.0/?function=' + escape( jQuery( '#docs-list' ).val() ) + '&amp;locale=en_US&amp;version=3.4.1&amp;redirect=true'); }" /></div>
				<p class="submit">
	<input type="submit" name="submit" id="submit" class="button-primary" value="Update File" tabindex="2"  />	</p>
</form>
<br class="clear" />
</div>
<script type="text/javascript">
/* <![CDATA[ */
jQuery(document).ready(function($){
	$('#template').submit(function(){ $('#scrollto').val( $('#newcontent').scrollTop() ); });
	$('#newcontent').scrollTop( $('#scrollto').val() );
});
/* ]]> */
</script>

<div class="clear"></div></div><!-- wpbody-content -->
<div class="clear"></div></div><!-- wpbody -->
<div class="clear"></div></div><!-- wpcontent -->

<div id="footer">
<p id="footer-left" class="alignleft"><span id="footer-thankyou">Thank you for creating with <a href="http://wordpress.org/">WordPress</a>.</span></p>
<p id="footer-upgrade" class="alignright">Version 3.4.1</p>
<div class="clear"></div>
</div>
		<script type="text/javascript">
		jQuery(function($) {
			$('.wpmudev-dismiss').click(function() {
				var $link = $(this), data = { 'action': 'wpmudev-dismiss' };
				$link.closest('.wpmudev-new, .wpmudev-message, .update-nag').fadeOut('fast');
				data[ $link.attr('data-key') ] = $link.attr('data-id');
				$.post(ajaxurl, data);
				return false;
			});
		});
		</script>
		<script type="text/javascript">
//<![CDATA[
	jQuery( '#ep_explain_more' ).hide();
	jQuery( '#ep_toggle_more' ).click( function() {
		jQuery( '#ep_explain_more' ).toggle();
		return false;
	} );
//]]>
</script>
<script type='text/javascript'>
/* <![CDATA[ */
var thickboxL10n = {"next":"Next >","prev":"< Prev","image":"Image","of":"of","close":"Close","noiframes":"This feature requires inline frames. You have iframes disabled or your browser does not support them.","loadingAnimation":"http:\/\/campaigns.occupy.net\/wp-includes\/js\/thickbox\/loadingAnimation.gif","closeImage":"http:\/\/campaigns.occupy.net\/wp-includes\/js\/thickbox\/tb-close.png"};var commonL10n = {"warnDelete":"You are about to permanently delete the selected items.\n  'Cancel' to stop, 'OK' to delete."};/* ]]> */
</script>
<script type='text/javascript' src='http://campaigns.occupy.net/wp-admin/load-scripts.php?c=0&amp;load=admin-bar,thickbox,hoverIntent,common,jquery-color&amp;ver=3.4.1'></script>
<script type='text/javascript' src='http://campaigns.occupy.net/wp-content/plugins/admin-menu-editor/js/menu-highlight-fix.js?ver=20120519'></script>

<div class="clear"></div></div><!-- wpwrap -->
<script type="text/javascript">if(typeof wpOnload=='function')wpOnload();</script>
</body>
</html>
