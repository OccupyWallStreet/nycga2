/*
 *
 * Wijmo Library 2.1.0
 * http://wijmo.com/
 *
 * Copyright(c) ComponentOne, LLC.  All rights reserved.
 * 
 * Dual licensed under the Wijmo Commercial or GNU GPL Version 3 licenses.
 * licensing@wijmo.com
 * http://wijmo.com/license
 *
 *
 **/
(function(a){"use strict";a.widget("wijmo.wijbarchart",a.wijmo.wijchartcore,{options:{horizontal:true,stacked:false,is100Percent:false,clusterOverlap:0,clusterWidth:85,clusterRadius:0,clusterSpacing:0,animation:{enabled:true,duration:400,easing:">"},seriesTransition:{enabled:true,duration:400,easing:">"},mouseDown:null,mouseUp:null,mouseOver:null,mouseOut:null,mouseMove:null,click:null},_create:function(){var c=this,b=c.options,e=c._getDefFill(),d;if(b.horizontal){d=b.axis.y.compass||"south";b.axis.y.compass=b.axis.x.compass||"west";b.axis.x.compass=d}a.extend(true,{compass:"east"},b.hint);a.each(b.seriesStyles,function(b,a){if(!a.fill)a.fill=e[b]});e=null;a.wijmo.wijchartcore.prototype._create.apply(c,arguments);c.chartElement.addClass("wijmo-wijbarchart")},_setOption:function(c,b){c==="horizontal"&&!b&&a.extend(true,this.options.axis,{x:{compass:"south"},y:{compass:"west"}});a.wijmo.wijchartcore.prototype._setOption.apply(this,arguments)},destroy:function(){var e=this,c=e.chartElement,d=c.data("fields"),b=d&&d.bars;c.removeClass("wijmo-wijbarchart");a.wijmo.wijchartcore.prototype.destroy.apply(this,arguments);b&&b.length&&a.each(b,function(b,a){a=null});c.data("fields",null)},_clearChartElement:function(){var b=this,d=b.options,c=b.chartElement.data("fields");a.wijmo.wijchartcore.prototype._clearChartElement.apply(b,arguments);b.element.removeData("plotInfos");if(!d.seriesTransition.enabled)if(c&&c.aniBarsAttr)c.aniBarsAttr=null},_isBarChart:function(){return true},getBar:function(c){var a=this.chartElement,b=a.data("fields");return b.chartElements.bars[c]},_paintTooltip:function(){var c=this,d=c.chartElement,b=d.data("fields");a.wijmo.wijchartcore.prototype._paintTooltip.apply(this,arguments);if(c.tooltip)if(b&&b.trackers&&b.trackers.length){c.tooltip.setTargets(b.trackers);c.tooltip.setOptions({relatedElement:b.trackers[0]})}},_getTooltipText:function(e,d){var c=a(d.node),b,f;if(c.data("owner"))c=c.data("owner");b=c.data("wijchartDataObj");f={data:b,value:b.value,label:b.label,total:b.total,target:d,fmt:e,x:b.x,y:b.y};return a.proxy(e,f)()},_paintPlotArea:function(){var b=this,c=b.options;b.chartElement.wijbar({canvas:b.canvas,bounds:b.canvasBounds,tooltip:b.tooltip,widgetName:b.widgetName,horizontal:c.horizontal,stacked:c.stacked,axis:c.axis,seriesList:c.seriesList,seriesStyles:c.seriesStyles,seriesHoverStyles:c.seriesHoverStyles,seriesTransition:c.seriesTransition,showChartLabels:c.showChartLabels,textStyle:c.textStyle,chartLabelStyle:c.chartLabelStyle,chartLabelFormatString:c.chartLabelFormatString,shadow:c.shadow,disabled:c.disabled,clusterOverlap:c.clusterOverlap,clusterWidth:c.clusterWidth,clusterSpacing:c.clusterSpacing,is100Percent:c.is100Percent,clusterRadius:c.clusterRadius,animation:c.animation,isYTime:b.axisInfo.y[0].isTime,isXTime:b.axisInfo.x.isTime,mouseDown:a.proxy(b._mouseDown,b),mouseUp:a.proxy(b._mouseUp,b),mouseOver:a.proxy(b._mouseOver,b),mouseOut:a.proxy(b._mouseOut,b),mouseMove:a.proxy(b._mouseMove,b),click:a.proxy(b._click,b)})},_showSerieEles:function(b){a.each(b,function(b,a){if(a.bar){a.bar.show();a.bar.shadow&&a.bar.shadow.show();a.bar.tracker&&a.bar.tracker.show()}a.dcl&&a.dcl.show();a.animatedBar&&!a.animatedBar.removed&&a.animatedBar.show()})},_hideSerieEles:function(b){a.each(b,function(b,a){if(a.bar){a.bar.hide();a.bar.shadow&&a.bar.shadow.hide();a.bar.tracker&&a.bar.tracker.hide()}a.dcl&&a.dcl.hide();a.animatedBar&&!a.animatedBar.removed&&a.animatedBar.hide()})},_calculateParameters:function(c,e){a.wijmo.wijchartcore.prototype._calculateParameters.apply(this,arguments);if(c.id==="x"){var d=e.unitMinor,b=this._getBarAdjustment(c);if(b===0)b=d;else if(d<b&&d!==0)b=Math.floor(b/d)*d;c.min-=b;c.max+=b;this._calculateMajorMinor(e,c)}},_getBarAdjustment:function(e){for(var a=0,h=this.options,g=e.max,b=e.min,d=h.seriesList,c=0,f=0,c=0;c<d.length&&d[c].data.x;c++){f=d[c].data.x.length;if(a<f)a=f}if(a>1)return(g-b)/a*h.clusterWidth*.0125;else if(a===1){if(b===0&&g===1){b=-1;e.min=b}return(g-b)*.0125}else return 0}});function b(c){var b=this;b.x=c;b.paSpec=[];b.stackValues=function(){var d=b.paSpec.length,c;if(d>1){c=b.paSpec[0];a.each(b.paSpec,function(b,a){if(b===0)return true;a.y+=c.y;c=a})}}}a.fn.extend({wijbar:function(c){var D=function(b,d,e){c.shadow&&a.wijchart.paintShadow(b,d,e)},u=a.wijraphael.addClass,E=a.wijchart.getScaling,A=a.wijchart.getTranslation,f=this,e=c.canvas,i=c.widgetName,d=c.horizontal,l=c.stacked,t=a.arrayClone(c.seriesList),v=t.length,C=[].concat(c.seriesStyles.slice(0,v)),z=[].concat(c.seriesHoverStyles.slice(0,v)),r=c.bounds,q=c.animation,I=q&&q.enabled,p={x:r.startX,y:r.startY},N=r.endX-p.x,L=r.endY-p.y,m=c.axis.x,x=c.axis.y,k=c.disabled,F=c.mouseDown,K=c.mouseUp,H=c.mouseOver,J=c.mouseOut,G=c.mouseMove,M=c.click,w=E(d,m.max,m.min,d?L:N),O=A(d,p,m.max,m.min,w),s,y,g=f.data("fields")||{},o=g.chartElements||{},j=g.aniBarsAttr,h,Z=c.isYTime,Y=c.isXTime;function W(d){for(var a=Number.MAX_VALUE,e=d.length,c,b=1;b<e;b++){c=d[b].x-d[b-1].x;if(c<a&&c>0)a=c}return a===Number.MAX_VALUE?2:a}function V(b){a.each(b,function(b,a){a.stackValues()});return b}function B(f){var c=[],d=a.wijchart.getXSortedPoints;function e(n,m){var h=d(m),l=m.length,f=null,o=0,e=0,g=0,k=true,i=0,j=false;if(h)o=h.length;if(c)g=c.length;if(h===undefined)return;a.each(h,function(d,a){if(k){k=false;i=a.x}else{if(i===a.x)j=true;else j=false;i=a.x}while(e<g&&c[e].x<a.x)e++;if(e<g)if(c[e].x!==a.x){f=new b(a.x,l);c.splice(e,0,f);g=c.length}else f=c[e];else{f=new b(a.x,l);c.push(f);g=c.length}f.paSpec.push({y:a.y,sIdx:n,pIdx:d,dupl:j})})}a.each(f,function(b,a){e(b,a)});return c}function n(a,c,b){return a<c?c:a>b?b:a}function R(c,d,e,f,g,b){a.each(b,function(j,a){var h=a.x,i=a.y,b=0;a.x=d*h+f;a.y=e*i+g;if(c){b=a.x;a.x=a.y;a.y=b}});return b}function P(b,n,m,l){var i=a.extend(true,{},c.textStyle,c.chartLabelStyle),h=d?{x:b.x+b.width,y:b.y+b.height/2}:{x:b.x+b.width/2,y:b.y},k=c.chartLabelFormatString,j,f,g=n;if(l)i=a.extend(true,i,l);if(m)g=a.fromOADate(n);if(k&&k.length)g=Globalize.format(g,c.chartLabelFormatString);else if(!m)g=a.round(g,2);f=e.text(h.x,h.y,g).attr(i);u(a(f.node),"wijbarchart-label");j=f.getBBox();if(d)f.attr({x:h.x+j.width/2});else f.attr({y:h.y-j.height/2});return f}function X(i,r,Q,v,w,s,H,F,E,M,p,C,O,L,t){var N=c.is100Percent,z=v.min,y=v.max,B=w.min,A=w.max,T=v.scale,U=v.late,I=w.scale,K=w.late,x,b,G,f,u=null,g,J=s,o=s["stroke-width"],S=s.stroke,h,m,j,k,q=-1;if(t.origin!==null)q=I*t.origin+K;if(l)if(N){if(C>0)i.height=r/C;if(p||p===0){i.y=p/C;i.height-=i.y}}else{i.height=r;if(p||p===0){i.height-=p;i.y=p}}else if(p||p===0){i.x+=i.width*(1-M);i.height=r}b=[{x:i.x,y:i.y},{x:i.x+i.width,y:i.y+i.height}];G=(z<=b[0].x&&b[0].x<=y||z<=b[1].x&&b[1].x<=y)&&(B<=b[0].y&&b[0].y<=A||B<=b[1].y&&b[1].y<=A);b[0].x=n(b[0].x,z,y);b[0].y=n(b[0].y,B,A);b[1].x=n(b[1].x,z,y);b[1].y=n(b[1].y,B,A);b=R(d,T,I,U,K,b);if(b[0].x>b[1].x){x=b[0].x;b[0].x=b[1].x;b[1].x=x}if(b[0].y>b[1].y){x=b[0].y;b[0].y=b[1].y;b[1].y=x}f={x:b[0].x,y:b[0].y,width:b[1].x-b[0].x,height:b[1].y-b[0].y};if(G){if(f.width===0)f.width=.5;if(f.height===0)f.height=.5}if(c.showChartLabels)u=P(f,r,O,L);g=s.r?s.r:c.clusterRadius;if(g)J=a.extend(true,{},s,{r:0});if(S!=="none"&&o)o=parseInt(o,10);if(!o||isNaN(o))o=0;m=f.width-o;j=f.height-o;if(m<0)m=0;if(j<0)j=0;if(H){if(q===-1)if(d)q=E.x;else q=E.y+Q-o;if(g){if(d){if(r>t.origin)h=e.roundRect(f.x,f.y,m,j,0,0,g,g).hide();else h=e.roundRect(f.x,f.y,m,j,g,g,0,0).hide();k=e.rect(q,f.y,0,j)}else{if(r>t.origin)h=e.roundRect(f.x,f.y,m,j,g,0,0,g).hide();else h=e.roundRect(f.x,f.y,m,j,0,g,g,0).hide();k=e.rect(f.x,q,f.width,0)}D(k,F);k.wijAttr(J);k.bar=h}else{if(d)h=e.rect(q,f.y,0,j);else h=e.rect(f.x,q,f.width,0);k=h}if(u){u.attr({opacity:0});k.chartLabel=u}k.left=f.x;k.top=f.y;k.width=m;k.height=j;k.r=g}else if(g)if(d)if(r>t.origin)h=e.roundRect(f.x,f.y,m,j,0,0,g,g);else h=e.roundRect(f.x,f.y,m,j,g,g,0,0);else if(r>t.origin)h=e.roundRect(f.x,f.y,m,j,g,0,0,g);else h=e.roundRect(f.x,f.y,m,j,0,g,g,0);else h=e.rect(f.x,f.y,m,j);D(h,F);if(H&&g)h.shadow&&h.shadow.hide();h.wijAttr(s);return{rect:f,dcl:u,animatedBar:k,bar:h}}function T(i,J,F,K,v,C,p,q,n,w){var f=c.clusterOverlap/100,H=c.clusterWidth/100,t=1,G=c.clusterSpacing+t,o=i.length,b,g,k=[],D=[],r=[],j=[],z=[],h=[],m=e.set();if(n||w){a.each(i,function(d,c){var b=a.extend(true,{},c);b.data&&b.data.y&&b.data.y.length&&n&&a.each(b.data.y,function(d,c){b.data.y[d]=a.toOADate(c)});b.data&&b.data.x&&b.data.x.length&&w&&a.each(b.data.x,function(d,c){b.data.x[d]=a.toOADate(c)});z.push(b)});b=B(z)}else b=B(i);if(l)b=V(b);g=W(b)*H;if(o>1&&!l){f-=b.length*(o-1)*G/(d?p:C);g/=o*(1-f)+f}a.each(b,function(o,B){var e=B.paSpec,G=e.length,z,w,c,b;if(l)z=g;else z=g*(G*(1-f)+f);w={x:B.x-z/2,y:0,width:g,height:e[0].y};a.each(e,function(g,N){if(!j[g])j[g]=[];if(!h[g])h[g]=[];if(w.height===undefined)return true;var H=N.sIdx,L=J[H],z=i[H],l,M=z.yAxis||0,B=x[M]||x,G=v[M]||v;s=E(!d,B.max,B.min,d?C:p);y=A(!d,q,B.max,B.min,s);G.late=y;G.scale=s;b=X(w,N.y,p,K,G,L,I,t,q,f,g>0?e[g-1].y:null,e[e.length-1].y,n,z.textStyle,B);c=b.bar;l=c.clone().attr({opacity:.01,fill:"white","stroke-width":0,"fill-opacity":.01});if(z.visible===false){c.hide();b.dcl&&b.dcl.hide();l.hide();c.shadow&&c.shadow.hide()}u(a(c.node),"wijchart-canvas-object wijbarchart");a(c.node).data("wijchartDataObj",a.extend(false,{index:o,bar:c,type:"bar",style:L,hoverStyle:F[H],x:z.data.x[o],y:z.data.y[o]},z));a(l.node).data("owner",a(c.node));u(a(l.node),"wijbarchart bartracker");b.bar.tracker=l;m.push(l);D.push(c);b.animatedBar&&r.push(b.animatedBar);b.dcl&&k.push(b.dcl);j[g][o]=b.rect;h[g][o]=b;c=null;l=null})});a.each(k,function(b,a){a.toFront()});m.toFront();return{bars:D,animatedBars:r,rects:j,chartLabels:k,seriesEles:h,trackers:m}}function U(k){var e=c.seriesTransition,f,h,i=[],b;if(I){f=q.duration||2e3;h=q.easing||"linear";a.each(k,function(g,c){var k=d?{width:c.width,x:c.left}:{height:c.height,y:c.top};if(j&&e.enabled)if(j.length>g){b=a.wijchart.getDiffAttrs(j[g],c.attr());if(d){b.x=j[g].x;b.width=j[g].width}else{b.y=j[g].y;b.height=j[g].height}if(b.path)delete b.path;c.attr(b);f=e.duration;h=e.easing}i.push(a.extend(true,{},c.attr(),k));c.tracker&&c.tracker.hide();c.stop().wijAnimate(k,f,h,function(){var a=this,c=a.r,b=a;a.chartLabel&&a.chartLabel.wijAnimate({opacity:1},250);if(a.tracker){a.tracker.show();a.tracker.attr({width:a.width,height:a.height,x:a.attr("x"),y:a.attr("y")})}if(c){b=a.bar;b.show();b.shadow&&b.shadow.show();if(a.shadow){a.shadow.wijRemove();a.shadow=null}a.wijRemove();a=null}})});g.aniBarsAttr=i}}function S(){var b=a.isFunction;a(".wijbarchart",f[0]).live("mousedown."+i,function(e){if(k)return;if(b(F)){var c=a(e.target),d;if(c.data("owner"))c=c.data("owner");d=c.data("wijchartDataObj");F.call(f,e,d);d=null}}).live("mouseup."+i,function(e){if(k)return;if(b(K)){var c=a(e.target),d;if(c.data("owner"))c=c.data("owner");d=c.data("wijchartDataObj");K.call(f,e,d);d=null}}).live("mouseover."+i,function(e){if(k)return;if(b(H)){var c=a(e.target),d;if(c.data("owner"))c=c.data("owner");d=c.data("wijchartDataObj");H.call(f,e,d);d=null}}).live("mouseout."+i,function(g){if(k)return;var d=a(g.target),c,e;if(d.data("owner"))d=d.data("owner");c=d.data("wijchartDataObj");e=c.bar;if(!c.hoverStyle)e&&e.attr({opacity:"1"});else e.attr(c.style);b(J)&&J.call(f,g,c);c=null}).live("mousemove."+i,function(g){if(k)return;var d=a(g.target),c,e;if(d.data("owner"))d=d.data("owner");c=d.data("wijchartDataObj");e=c.bar;if(!c.hoverStyle)e&&e.attr({opacity:"0.8"});else e.attr(c.hoverStyle);b(G)&&G.call(f,g,c);c=null}).live("click."+i,function(e){if(k)return;if(b(M)){var c=a(e.target),d;if(c.data("owner"))c=c.data("owner");d=c.data("wijchartDataObj");M.call(f,e,d)}})}function Q(){a(".wijbarchart",f[0]).die(i).die("."+i)}Q();if(d&&!l){t.reverse();C.reverse();z.reverse()}if(v===0)return;h=T(t,C,z,{min:m.min,max:m.max,late:O,scale:w},x,N,L,p,Z,Y);f.data("plotInfos",{xscale:w,xlate:O,yscale:s,ylate:y,rects:h.rects});U(h.animatedBars);o.bars=h.bars;o.animatedBars=h.animatedBars;o.chartLabels=h.chartLabels;g.seriesEles=h.seriesEles;g.trackers=h.trackers;if(!g.chartElements)g.chartElements={};d&&!l&&g.seriesEles.reverse();a.extend(true,g.chartElements,o);f.data("fields",g);S()}})})(jQuery);